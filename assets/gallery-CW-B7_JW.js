const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/three-Br820KFa.js","assets/vendor-RxfllKF0.js","assets/d3-BbFmVfHF.js","assets/vendor-DSulWsr7.css"])))=>i.map(i=>d[i]);
import{r as M,j as i}from"./react-N-_5-tx-.js";import{P as pe}from"./vendor-RxfllKF0.js";import{C as He,R as xt,a as wt,b as ot,c as re,T as bt,d as vt,M as te,P as ht,D as Ee,e as $e,f as Me,S as Ge,g as Ke,L as St,h as kt,i as Mt,O as Lt,W as Pt,j as It,k as Fe,l as At,m as Be,B as ae,n as Oe,o as je,p as ke,F as Re,V as at,q as Te,r as zt,G as rt,s as lt,t as _e,u as ct}from"./three-Br820KFa.js";import{u as Ce,_ as jt}from"./about-0oYHbQoY.js";import{t as be}from"./texture-system-CJg_ha0h.js";const Ct=M.createContext(),Et=()=>{const p=M.useContext(Ct);if(!p)throw new Error("usePhotoSwipe must be used within a PhotoSwipeProvider");return p},dt=({size:p=120,strokeWidth:e=8,showMask:t=!0,maskColor:s="black-glass",className:l="",onMaskClick:g=null})=>{const d=(p-e)/2,W=2*Math.PI*d,ie=0,ee=()=>{switch(s){case"black-solid":return"absolute inset-0 bg-black";case"black-glass":return"absolute inset-0 bg-black/80 backdrop-blur-sm";case"default":default:return"absolute inset-0 bg-black/40 backdrop-blur-lg backdrop-saturate-150"}},se=({className:k=""})=>i.jsxs("div",{className:`relative ${k}`,style:{width:p,height:p,overflow:"visible"},children:[i.jsx("div",{className:"absolute pointer-events-none",style:{width:p+80,height:p+80,top:-40,left:-40,borderRadius:"50%",background:`radial-gradient(circle, 
                            transparent 60%, 
                            rgba(var(--theme-primary-rgb), 0.25) 75%, 
                            rgba(var(--theme-primary-rgb), 0.15) 85%, 
                            rgba(var(--theme-primary-rgb), 0.08) 92%, 
                            transparent 100%
                        )`,boxShadow:`
                            0 0 ${Math.max(p*.1,15)}px rgba(var(--theme-primary-rgb), 0.4),
                            0 0 ${Math.max(p*.2,25)}px rgba(var(--theme-primary-rgb), 0.2),
                            inset 0 0 ${Math.max(p*.05,6)}px rgba(var(--theme-primary-rgb), 0.15)
                        `,animation:"breathing-glow 3s ease-in-out infinite",zIndex:2}}),i.jsx("div",{className:"absolute",style:{width:p,height:p,borderRadius:"50%",boxShadow:`
                            0 0 ${Math.max(p*.03,4)}px var(--theme-primary),
                            0 0 ${Math.max(p*.06,8)}px rgba(var(--theme-primary-rgb), 0.6),
                            0 0 ${Math.max(p*.09,12)}px rgba(var(--theme-primary-rgb), 0.4),
                            inset 0 0 ${Math.max(p*.02,3)}px rgba(var(--theme-primary-rgb), 0.2)
                        `,animation:"avatar-glow 3s ease-in-out infinite",zIndex:9}}),i.jsxs("svg",{width:p,height:p,className:"transform -rotate-90 relative",style:{zIndex:10},children:[i.jsx("circle",{cx:p/2,cy:p/2,r:d,fill:"none",stroke:"rgba(255, 255, 255, 0.2)",strokeWidth:e}),i.jsx("circle",{cx:p/2,cy:p/2,r:d,fill:"none",stroke:"var(--theme-primary)",strokeWidth:e,strokeLinecap:"round",strokeDasharray:W,strokeDashoffset:ie,className:"transition-all duration-300 ease-out",style:{transformOrigin:"center"}})]}),i.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",style:{zIndex:20},children:i.jsx("span",{className:"text-white/90 text-lg font-medium drop-shadow-md",children:"Loading..."})})]});return t?i.jsxs("div",{className:`fixed inset-0 z-50 flex items-center justify-center ${l}`,onClick:g,style:{overflow:"visible"},children:[i.jsx("div",{className:ee()}),i.jsx("div",{className:"relative z-10",children:i.jsx(se,{})})]}):i.jsx(se,{className:l})};dt.propTypes={size:pe.number,strokeWidth:pe.number,showMask:pe.bool,maskColor:pe.oneOf(["black-glass","black-solid","default"]),className:pe.string,onMaskClick:pe.func};const mt=({language:p="zh"})=>{const e=Ce(k=>k.getAllGalleryItems()),{openPhotoSwipe:t}=Et(),s=M.useRef(null),[l,g]=M.useState(new Map),[d,N]=M.useState(9),W=M.useMemo(()=>Array.isArray(e)?e.filter(k=>k.type!=="video"):[],[e]),ie=async k=>{try{if(!k||k.match(/\.(mp4|webm|mov|avi|mkv)$/i)||!k.match(/\.(jpg|jpeg|png|webp|avif)$/i))return k;const E=k.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,"");return await be.getOptimalPath(E,"gallery")}catch(E){return console.warn("移动端图片格式优化失败，使用原始路径:",E),k}};M.useEffect(()=>{(async()=>{if(W.length===0)return;const E=W.slice(0,d),P=new Map;for(const R of E)if(R.src&&!l.has(R.id)){const D=await ie(R.src),ge=R.thumbnail?await ie(R.thumbnail):D;P.set(R.id,{src:D,thumbnail:ge})}P.size>0&&g(R=>new Map([...R,...P]))})()},[W,d,l]),M.useEffect(()=>{const k=()=>{const P=s.current;if(!P)return;const{scrollTop:R,scrollHeight:D,clientHeight:ge}=P;R+ge>=D-200&&d<W.length&&N(fe=>Math.min(fe+6,W.length))},E=s.current;if(E)return E.addEventListener("scroll",k,{passive:!0}),()=>E.removeEventListener("scroll",k)},[d,W.length]);const ee=W.slice(0,d).map((k,E)=>{const P=l.get(k.id);return{id:k.id||E,src:(P==null?void 0:P.src)||k.src,thumbnail:(P==null?void 0:P.thumbnail)||k.thumbnail||k.src,title:k.title||"",description:k.description||""}}),se=k=>{const E=W.map((P,R)=>{const D=l.get(P.id);return{id:P.id||R,src:(D==null?void 0:D.src)||P.src,thumbnail:(D==null?void 0:D.thumbnail)||P.thumbnail||P.src,title:P.title||"",description:P.description||""}});t(E,k)};return i.jsxs(i.Fragment,{children:[i.jsx("style",{children:`
        .gallery-mobile-container {
          min-height: 100vh;
          max-height: 100vh;
          overflow-y: auto;
          overflow-x: hidden;
          overscroll-behavior: none;
          
          /* iOS 安全区域支持 */
          padding-top: max(1rem, env(safe-area-inset-top));
          padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
          padding-left: env(safe-area-inset-left);
          padding-right: env(safe-area-inset-right);
          
          /* 确保在iOS上平滑滚动 */
          -webkit-overflow-scrolling: touch;
          
          /* 防止选择文本 */
          -webkit-user-select: none;
          user-select: none;
          
          /* 确保触摸滚动正常工作 */
          touch-action: pan-y;
        }
        
        /* 自定义滚动条样式 */
        .gallery-mobile-container::-webkit-scrollbar {
          width: 4px;
        }
        .gallery-mobile-container::-webkit-scrollbar-track {
          background: transparent;
        }
        .gallery-mobile-container::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.2);
          border-radius: 2px;
        }
        .gallery-mobile-container::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.3);
        }
        
        /* 移动端特殊处理 */
        @media (max-width: 768px) {
          .gallery-mobile-container {
            /* 在移动设备上隐藏滚动条 */
            scrollbar-width: none;
            -ms-overflow-style: none;
          }
          
          .gallery-mobile-container::-webkit-scrollbar {
            display: none;
          }
          
          /* 确保图片点击区域可用 */
          .gallery-image-item {
            touch-action: manipulation;
          }
        }
      `}),i.jsxs("div",{ref:s,className:"gallery-mobile-container w-full",children:[i.jsxs("div",{className:"text-center mb-8 px-4",children:[i.jsx("h2",{className:"text-3xl md:text-4xl font-bold text-theme-text-primary mb-4",children:p==="zh"?"作品集":"Gallery"}),i.jsx("p",{className:"text-theme-text-secondary max-w-2xl mx-auto leading-relaxed",children:p==="zh"?"记录生活中的美好瞬间，每一张照片都承载着独特的故事与回忆。":"Capturing beautiful moments in life, each photo carries unique stories and memories."}),i.jsx("p",{className:"text-theme-text-secondary/60 text-sm mt-2",children:p==="zh"?"点击图片查看大图":"Tap images to view full size"})]}),i.jsxs("div",{className:"max-w-6xl mx-auto px-4",children:[i.jsx("div",{className:"grid grid-cols-3 gap-2 sm:gap-3 md:gap-4 pb-16",children:ee.map((k,E)=>{const P=l.get(k.id),R=(P==null?void 0:P.thumbnail)||(P==null?void 0:P.src);return i.jsx("div",{onClick:()=>se(E),className:"group project-card cursor-pointer transform transition-all duration-300 active:scale-95",children:i.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden bg-theme-surface/10",children:[R?i.jsx("img",{src:R,alt:`Gallery item ${E+1}`,className:"w-full h-full object-cover",loading:"lazy",onError:D=>{console.warn(`📱 优化图片加载失败，回退到原始图片: ${k.id}`),D.target.src=k.thumbnail||k.src}}):i.jsx("div",{className:"w-full h-full flex items-center justify-center bg-theme-surface/20",children:i.jsx("div",{className:"w-8 h-8 border-2 border-theme-text-secondary/30 border-t-theme-text-secondary rounded-full animate-spin"})}),i.jsx("div",{className:"absolute inset-0 bg-black/20 opacity-0 group-active:opacity-100 transition-opacity duration-200 flex items-center justify-center",children:i.jsx("div",{className:"w-8 h-8 border-2 border-white rounded-full flex items-center justify-center",children:i.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})})]})},k.id)})}),d<W.length&&i.jsxs("div",{className:"text-center py-8",children:[i.jsxs("div",{className:"inline-flex items-center justify-center space-x-2 text-theme-text-secondary",children:[i.jsx("div",{className:"w-4 h-4 border-2 border-theme-text-secondary/30 border-t-theme-text-secondary rounded-full animate-spin"}),i.jsx("span",{className:"text-sm",children:p==="zh"?"加载更多图片...":"Loading more images..."})]}),i.jsx("div",{className:"text-xs text-theme-text-secondary/60 mt-2",children:p==="zh"?`已显示 ${d} / ${W.length} 张图片`:`Showing ${d} / ${W.length} images`})]}),ee.length===0&&i.jsxs("div",{className:"text-center py-16",children:[i.jsx("div",{className:"w-16 h-16 bg-theme-surface/20 rounded-full flex items-center justify-center mx-auto mb-4",children:i.jsx("svg",{className:"w-8 h-8 text-theme-text-secondary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:i.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),i.jsx("div",{className:"text-theme-text-secondary text-lg mb-2",children:p==="zh"?"暂无图片内容":"No gallery items available"}),i.jsx("div",{className:"text-theme-text-secondary/60 text-sm",children:p==="zh"?"请稍后再试":"Please try again later"})]}),ee.length>0&&i.jsxs("div",{className:"text-center mt-8 pb-16 mb-8",children:[i.jsx("p",{className:"text-theme-text-secondary/60 text-sm",children:p==="zh"?`共 ${ee.length} 张图片 • 点击查看大图`:`${ee.length} images • Tap to view full size`}),i.jsx("div",{className:"h-20"})]})]})]})]})};mt.propTypes={language:pe.string};class $t{constructor(e,t={}){this.scene=e,this.rectLights=[],this.helpers=[],this.animationId=null,this.config={intensity:t.intensity||5,colors:t.colors||[16739179,5164484,4569041,16370212],showHelpers:t.showHelpers||!1,enableAnimation:t.enableAnimation!==!1,animationSpeed:t.animationSpeed||.001,lightWidth:t.lightWidth||6,lightHeight:t.lightHeight||8,positions:t.positions||[{x:-18,y:8,z:15,rx:0,ry:0,rz:0},{x:18,y:8,z:15,rx:0,ry:Math.PI,rz:0},{x:0,y:10,z:35,rx:-Math.PI/2,ry:0,rz:0},{x:0,y:10,z:-15,rx:-Math.PI/2,ry:Math.PI,rz:0}]},this.clock=new He,this.init()}init(){xt.init(),this.createRectAreaLights(),this.config.enableAnimation&&this.startAnimation()}createRectAreaLights(){this.config.positions.forEach((e,t)=>{const s=this.config.colors[t%this.config.colors.length],l=new wt(s,this.config.intensity,this.config.lightWidth,this.config.lightHeight);if(l.position.set(e.x,e.y,e.z),l.rotation.set(e.rx,e.ry,e.rz),this.scene.add(l),this.rectLights.push(l),this.config.showHelpers){const g=new ot(l);this.scene.add(g),this.helpers.push(g)}l.userData={originalIntensity:this.config.intensity,originalColor:new re(s),animationPhase:t/this.config.positions.length*Math.PI*2,index:t}})}startAnimation(){const e=()=>{this.animationId=requestAnimationFrame(e),this.updateAnimation()};e()}updateAnimation(){const e=this.clock.getElapsedTime();this.rectLights.forEach((t,s)=>{const l=t.userData,g=Math.sin(e*this.config.animationSpeed*1e3+l.animationPhase);t.intensity=l.originalIntensity+g*2;const d=Math.sin(e*this.config.animationSpeed*500+l.animationPhase*2)*.1;switch(t.color.copy(l.originalColor),s){case 0:t.color.r=Math.max(.3,t.color.r+d);break;case 1:t.color.g=Math.max(.3,t.color.g+d),t.color.b=Math.max(.3,t.color.b+d);break;case 2:t.color.b=Math.max(.3,t.color.b+d);break;case 3:t.color.r=Math.max(.3,t.color.r+d),t.color.g=Math.max(.3,t.color.g+d);break}})}setIntensity(e){this.config.intensity=e,this.rectLights.forEach(t=>{t.userData.originalIntensity=e})}setAnimationSpeed(e){this.config.animationSpeed=e}toggleHelpers(){this.config.showHelpers=!this.config.showHelpers,this.config.showHelpers?this.rectLights.forEach(e=>{const t=new ot(e);this.scene.add(t),this.helpers.push(t)}):(this.helpers.forEach(e=>{this.scene.remove(e)}),this.helpers=[])}setPreset(e){switch(e){case"warm":this.config.colors=[16739179,16370212,16752627,15620644],this.setIntensity(6),this.setAnimationSpeed(8e-4);break;case"cool":this.config.colors=[5164484,4569041,10837738,2547329],this.setIntensity(5),this.setAnimationSpeed(.0012);break;case"dramatic":this.config.colors=[16726072,3093826,16737096,8121759],this.setIntensity(8),this.setAnimationSpeed(.002);break;case"soft":this.config.colors=[16771751,14524637,10016968,16243823],this.setIntensity(3),this.setAnimationSpeed(5e-4);break}this.rectLights.forEach((t,s)=>{const l=this.config.colors[s%this.config.colors.length];t.userData.originalColor=new re(l)})}toggleAnimation(){this.config.enableAnimation=!this.config.enableAnimation,this.config.enableAnimation?this.startAnimation():(this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.rectLights.forEach(e=>{e.intensity=e.userData.originalIntensity,e.color.copy(e.userData.originalColor)}))}getStatus(){return{intensity:this.config.intensity,animationSpeed:this.config.animationSpeed,enableAnimation:this.config.enableAnimation,showHelpers:this.config.showHelpers,lightCount:this.rectLights.length}}dispose(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.rectLights.forEach(e=>{this.scene.remove(e)}),this.rectLights=[],this.helpers.forEach(e=>{this.scene.remove(e)}),this.helpers=[]}}class Nt{generatePositionsFromGallery(){return null}extractBaseName(e){return e?e.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,""):null}constructor(e,t={},s=[]){this.scene=e,this.galleryData=s,this.lightCylinders=[],this.animationId=null,this.textureLoader=new bt,this.roomConfig={floorY:-2,ceilingY:8,height:10},this.config={radius:t.radius||.5,height:this.roomConfig.height,radialSegments:t.radialSegments||32,heightSegments:t.heightSegments||1,cubeWidth:t.cubeWidth||1,cubeHeight:t.cubeHeight||8,cubeDepth:t.cubeDepth||1,cubeCount:t.cubeCount||3,enableTexture:t.enableTexture!==!1,textureUrl:t.textureUrl||null,textureDelay:t.textureDelay||1e3,baseColor:t.baseColor||16711744,enableGlow:t.enableGlow!==!1,glowIntensity:t.glowIntensity||.7,emissiveIntensity:t.emissiveIntensity||.3,positions:[{x:-5,z:18,color:65535,textureBaseName:null},{x:5,z:18,color:16711744,textureBaseName:null},{x:0,z:-18,color:65416,textureBaseName:"gallery-horizontal-11",radius:1.618,rotationY:Math.PI/1.5}],intensity:t.intensity||20,lightIntensity:t.lightIntensity||20,lightDistance:t.lightDistance||80,enableAnimation:t.enableAnimation!==!1,animationSpeed:t.animationSpeed||.001,colors:[65535,16711744,65416]},this.clock=new He,this.lightCubes=this.lightCylinders}async init(){console.log("🏛️ 初始化发光圆柱体系统（从地板到天花板）..."),await this.preloadTextures(),this.createLightCylinders(),this.config.enableAnimation&&this.startAnimation()}async preloadTextures(){try{console.log("⏩ 跳过纹理预加载，使用按需加载策略")}catch(e){console.warn("⚠️ 纹理预加载失败，将使用原始路径:",e)}}createLightCubes(){this.createLightCylinders()}createLightCylinders(){this.config.positions.forEach((e,t)=>{this.createSingleLightCylinder(e,t)}),console.log(`✅ 所有 ${this.config.positions.length} 个发光圆柱体创建完成（纹理将延迟加载）`)}createSingleLightCube(e,t,s,l){const g={x:e,z:s,color:this.config.colors[l]||this.config.baseColor,textureBaseName:null};this.createSingleLightCylinder(g,l)}createSingleLightCylinder(e,t){const s={position:{x:e.x,y:2,z:e.z},mesh:null,light:null,index:t,config:e},l=e.radius||this.config.radius,g=this.config.height-.05,d=new vt(l,l,g,this.config.radialSegments,this.config.heightSegments),N=this.createCylinderMaterial(e,t),W=new te(d,N),ie=(this.roomConfig.floorY+this.roomConfig.ceilingY)/2;if(W.position.set(e.x,ie,e.z),e.rotationY!==void 0&&(W.rotation.y=e.rotationY,console.log(`🔄 柱子绕Y轴旋转: ${(e.rotationY*180/Math.PI).toFixed(1)}度`)),this.scene.add(W),s.mesh=W,s.position.y=ie,this.config.enableGlow){const se=new ht(e.color,this.config.lightIntensity,this.config.lightDistance);se.position.set(e.x,ie,e.z),this.scene.add(se),s.light=se}s.originalColor=new re(e.color),s.originalIntensity=this.config.lightIntensity,s.animationPhase=t*Math.PI*.6,this.lightCylinders.push(s);const ee=["Lightbox前左侧柱子(32米墙的1/3位置，约-10.67米) - 青色主题","Lightbox前右侧柱子(32米墙的2/3位置，约10.67米) - 红色主题","摄像机背后绿色柱子(从地板到天花板，黄金比例直径) - 绿色主题"];console.log(`🏛️ 创建发光圆柱体 ${t+1}: ${ee[t]} 位置(${e.x}, ${ie}, ${e.z}), 高度${this.config.height}米, 半径${l}米, 直径${(l*2).toFixed(3)}米`),e.textureUrl&&console.log(`🖼️ 圆柱体 ${t+1} 应用贴图: ${e.textureUrl}`)}createCylinderMaterial(e,t){const s=e.color||this.config.baseColor,l=e.textureBaseName||this.config.textureBaseName;let g={transparent:!0,opacity:.9,side:Ee};g={...g,color:s,emissive:new re(s).multiplyScalar(this.config.emissiveIntensity)};const d=new $e(g);return l&&this.config.enableTexture&&setTimeout(async()=>{try{console.log(`🖼️ 延迟加载圆柱体 ${t+1} 的纹理: ${l}`);const N=await this.loadGalleryTexture(l);N.repeat.set(1,1),d.map=N,d.color=new re(1,1,1),d.needsUpdate=!0,console.log(`✅ 圆柱体 ${t+1} 纹理加载完成: ${l}`)}catch(N){console.warn(`❌ 圆柱体 ${t+1} 纹理加载失败: ${l}`,N)}},this.config.textureDelay||2e3),d}setTexture(e,t){if(e>=0&&e<this.lightCylinders.length){const s=this.lightCylinders[e];if(t){console.log(`🖼️ 为圆柱体 ${e+1} 设置新贴图: ${t}`);const l=this.textureLoader.load(t);l.wrapS=Me,l.wrapT=Me,l.repeat.set(1,1);const g=new $e({map:l,transparent:!0,opacity:.9,emissive:new re(s.config.color).multiplyScalar(this.config.emissiveIntensity),side:Ee});s.mesh&&s.mesh.material&&(s.mesh.material.dispose(),s.mesh.material=g),console.log(`✅ 圆柱体 ${e+1} 贴图已应用，照明功能保持正常`)}else{console.log(`🔄 移除圆柱体 ${e+1} 的贴图，恢复发光效果`);const l=new $e({color:s.config.color,transparent:!0,opacity:.9,emissive:new re(s.config.color).multiplyScalar(this.config.emissiveIntensity),side:Ee});s.mesh&&s.mesh.material&&(s.mesh.material.dispose(),s.mesh.material=l)}}}startAnimation(){const e=()=>{this.config.enableAnimation&&(this.updateAnimation(),this.animationId=requestAnimationFrame(e))};e()}updateAnimation(){const e=this.clock.getElapsedTime();this.lightCylinders.forEach(t=>{if(t.light){const s=Math.sin(e*this.config.animationSpeed*1e3+t.animationPhase)*.3+.7;t.light.intensity=t.originalIntensity*s;const l=Math.sin(e*this.config.animationSpeed*500+t.animationPhase)*.1,g={};t.originalColor.getHSL(g),g.h=(g.h+l)%1;const d=new re().setHSL(g.h,g.s,g.l);t.light.color.copy(d),t.mesh&&t.mesh.material&&(t.mesh.material.map||(t.mesh.material.color.copy(d),t.mesh.material.emissive&&t.mesh.material.emissive.copy(d.clone().multiplyScalar(this.config.emissiveIntensity))))}})}stopAnimation(){this.config.enableAnimation=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}setIntensity(e){this.setLightIntensity(e)}setLightIntensity(e){this.config.lightIntensity=e,this.config.intensity=e,this.lightCylinders.forEach(t=>{t.originalIntensity=e,t.light&&(t.light.intensity=e)})}toggleAnimation(){this.config.enableAnimation=!this.config.enableAnimation,this.config.enableAnimation?this.startAnimation():this.stopAnimation()}getStatus(){return{cylinderCount:this.lightCylinders.length,cubeCount:this.lightCylinders.length,lightIntensity:this.config.lightIntensity,intensity:this.config.intensity,enableAnimation:this.config.enableAnimation,enableTexture:this.config.enableTexture,radius:this.config.radius,height:this.config.height}}dispose(){this.stopAnimation(),this.lightCylinders.forEach(e=>{e.mesh&&(this.scene.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose()),e.light&&this.scene.remove(e.light)}),this.lightCylinders=[],console.log("🏛️ 发光圆柱体系统已清理")}getBestTexturePath(e){return!e||!e.startsWith("/gallery/")?e:e.split("/").pop().replace(".jpg","")}async loadGalleryTexture(e){if(!e)throw new Error("基础名称不能为空");try{console.log(`🖼️ 使用textureSystem加载Gallery纹理: ${e}`);const t=await be.getCompressionInfo();console.log(`🎯 当前浏览器支持格式: ${t.format} (${t.description})`);const s=await be.loadTexture(e);return console.log(`✅ Gallery纹理加载成功: ${e}`),s}catch(t){throw console.error(`❌ Gallery纹理加载失败: ${e}`,t),t}}}class Wt{constructor(e,t,s={}){this.scene=e,this.renderer=t,this.spotlights=[],this.animationId=null,this.config={lightCount:s.lightCount||4,ceilingHeight:s.ceilingHeight||10,positions:[{x:-36,y:10,z:0},{x:36,y:10,z:0},{x:0,y:10,z:-24}],targets:[{x:-32,y:1,z:0},{x:32,y:1,z:0},{x:0,y:1,z:-20}],intensity:s.intensity||3500,distance:s.distance||70,angle:s.angle||Math.PI/2,penumbra:s.penumbra||.3,colors:[16711744,65416,65535],enableAnimation:s.enableAnimation!==!1,animationSpeed:s.animationSpeed||.5,showHelpers:s.showHelpers||!1},this.clock=new He,this.init()}async init(){try{await this.createSpotlights(),this.config.enableAnimation&&this.startAnimation(),console.log("✨ IES聚光灯系统初始化完成")}catch(e){console.warn("⚠️ IES聚光灯初始化失败，使用标准聚光灯:",e),this.createStandardSpotlights()}}async createSpotlights(){let e=null;try{e=(await jt(()=>import("./three-Br820KFa.js").then(s=>s.ab),__vite__mapDeps([0,1,2,3]))).IESSpotLight}catch(t){console.log("🎯 IESSpotLight不可用:",t.message)}e&&this.renderer.isWebGPURenderer?(console.log("🎯 使用IES聚光灯 (WebGPU)"),await this.createIESSpotlights(e)):(console.log("🎯 使用标准聚光灯（降级方案）"),this.createStandardSpotlights())}async createIESSpotlights(e){for(let t=0;t<this.config.lightCount;t++){const s=this.config.positions[t],l=this.config.targets[t],g=this.config.colors[t%this.config.colors.length],d=new e(g,this.config.intensity);if(d.position.set(s.x,s.y,s.z),d.angle=this.config.angle,d.penumbra=this.config.penumbra,d.distance=this.config.distance,d.castShadow=!0,d.shadow.mapSize.width=2048,d.shadow.mapSize.height=2048,d.shadow.camera.near=.5,d.shadow.camera.far=this.config.distance,d.shadow.bias=-1e-4,d.shadow.normalBias=.02,d.target.position.set(l.x,l.y,l.z),this.scene.add(d),this.scene.add(d.target),this.config.showHelpers){const W=new Ge(d);d.userData.helper=W,this.scene.add(W)}const N={light:d,originalPosition:{...s},originalTarget:{...l},originalIntensity:this.config.intensity,originalColor:new re(g),animationPhase:t*Math.PI*.5,index:t};this.spotlights.push(N),console.log(`💡 创建IES聚光灯 ${t+1}: 位置(${s.x}, ${s.y}, ${s.z}) -> 目标(${l.x}, ${l.y}, ${l.z})`)}}createStandardSpotlights(){for(let e=0;e<this.config.lightCount;e++){const t=this.config.positions[e],s=this.config.targets[e],l=this.config.colors[e%this.config.colors.length],g=new Ke(l,this.config.intensity,this.config.distance,this.config.angle,this.config.penumbra);if(g.position.set(t.x,t.y,t.z),g.castShadow=!0,g.shadow.mapSize.width=2048,g.shadow.mapSize.height=2048,g.shadow.camera.near=.5,g.shadow.camera.far=this.config.distance,g.shadow.bias=-1e-4,g.shadow.normalBias=.02,g.target.position.set(s.x,s.y,s.z),this.scene.add(g),this.scene.add(g.target),this.config.showHelpers){const N=new Ge(g);g.userData.helper=N,this.scene.add(N)}const d={light:g,originalPosition:{...t},originalTarget:{...s},originalIntensity:this.config.intensity,originalColor:new re(l),animationPhase:e*Math.PI*.5,index:e};this.spotlights.push(d),console.log(`💡 创建标准聚光灯 ${e+1}: 位置(${t.x}, ${t.y}, ${t.z}) -> 目标(${s.x}, ${s.y}, ${s.z})`)}}startAnimation(){const e=()=>{this.config.enableAnimation&&(this.updateAnimation(),this.animationId=requestAnimationFrame(e))};e()}updateAnimation(){const e=this.clock.getElapsedTime()*this.config.animationSpeed;this.spotlights.forEach((t,s)=>{const{light:l,originalTarget:g,animationPhase:d}=t,N=e+d,W=2,ie=g.x+Math.sin(N*.8)*W*.3,ee=g.z+Math.cos(N*.6)*W*.3,se=g.y+Math.sin(N*.4)*.5;l.target.position.x=ie,l.target.position.y=se,l.target.position.z=ee;const k=.9,E=Math.sin(N*1.2+s*.5)*.2;l.intensity=t.originalIntensity*(k+E);const P=Math.sin(N*.8+s*.6)*.3,R={};t.originalColor.getHSL(R);const D=(R.h+P+e*.1)%1,ge=Math.max(.7,R.s+Math.sin(N*1.5)*.3),J=Math.max(.4,Math.min(.8,R.l+Math.sin(N*2)*.2)),fe=new re().setHSL(D,ge,J);l.color.copy(fe);const le=Math.sin(N*.5+s*.3)*.02;l.angle=this.config.angle+le,l.userData.helper&&l.userData.helper.update()})}setIntensity(e){this.config.intensity=e,this.spotlights.forEach(t=>{t.originalIntensity=e,t.light.intensity=e})}setAnimationSpeed(e){this.config.animationSpeed=e}toggleHelpers(){this.config.showHelpers=!this.config.showHelpers,this.spotlights.forEach(e=>{const{light:t}=e;if(this.config.showHelpers){if(!t.userData.helper){const s=new Ge(t);t.userData.helper=s,this.scene.add(s)}t.userData.helper.visible=!0}else t.userData.helper&&(t.userData.helper.visible=!1)})}toggleAnimation(){this.config.enableAnimation=!this.config.enableAnimation,this.config.enableAnimation?this.startAnimation():this.stopAnimation()}stopAnimation(){this.config.enableAnimation=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}getStatus(){return{lightCount:this.config.lightCount,intensity:this.config.intensity,enableAnimation:this.config.enableAnimation,showHelpers:this.config.showHelpers,animationSpeed:this.config.animationSpeed}}dispose(){this.stopAnimation(),this.spotlights.forEach(e=>{const{light:t}=e;t&&(this.scene.remove(t),this.scene.remove(t.target),t.userData.helper&&this.scene.remove(t.userData.helper))}),this.spotlights=[],console.log("🧹 IES聚光灯系统已清理")}}const gt=({language:p="en"})=>{var Xe,Ze,Je,Qe,et,tt,it;const[e,t]=M.useState(!0),[s,l]=M.useState(!1),[g,d]=M.useState(!1),[N,W]=M.useState(!1),[ie,ee]=M.useState(!1),[se,k]=M.useState(!1),E=Ce(j=>j.getAllGalleryItems()),P=Ce(j=>j.texts),R=Ce(j=>j.isPointerLocked),D=Ce(j=>j.setIsPointerLocked),ge=M.useRef(new Map),J=M.useRef({w:!1,a:!1,s:!1,d:!1,ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1});M.useEffect(()=>{const j=()=>{const ce=window.innerWidth<=768||"ontouchstart"in window;W(ce),ce&&ee(!0)};return j(),window.addEventListener("resize",j),()=>window.removeEventListener("resize",j)},[]);const fe=M.useRef(null),le=M.useRef(null),me=M.useRef(null),ye=M.useRef(null),F=M.useRef(null),Ne=M.useRef(null),ut=M.useRef(new He),Ue=M.useRef(null),Ve=M.useRef([]),qe=M.useRef(null),Ye=M.useRef([]),Le=M.useRef(null),Pe=M.useRef(null),We=M.useRef(null),ue=M.useRef(null),pt=M.useRef(null),ft=M.useRef(null);return M.useEffect(()=>{if(!fe.current)return;const j=fe.current,ce=f=>{const h=new rt;f.add(h),Ue.current=h;const y=32,z=72,G=new je(y,z),m=(()=>{const w=document.createElement("canvas"),a=1024;w.width=a,w.height=a;const n=w.getContext("2d"),I="#1a1a1a",O=["#262626","#2a2a2a","#1e1e1e","#333333","#2d2d2d"];n.fillStyle=I,n.fillRect(0,0,a,a);for(let C=0;C<2e3;C++){const H=Math.random()*a,de=Math.random()*a,Q=Math.random()*8+2,ne=Math.random()*.3+.1;n.globalAlpha=ne,n.fillStyle=O[Math.floor(Math.random()*O.length)],n.beginPath(),n.arc(H,de,Q,0,Math.PI*2),n.fill()}n.globalAlpha=.15,n.strokeStyle="#404040",n.lineWidth=1;for(let C=0;C<50;C++){const H=Math.random()*a,de=Math.random()*a,Q=Math.random()*100+50,ne=Math.random()*Math.PI*2;n.beginPath(),n.moveTo(H,de),n.lineTo(H+Math.cos(ne)*Q,de+Math.sin(ne)*Q),n.stroke()}const q=n.createRadialGradient(a/2,a/2,0,a/2,a/2,a/2);q.addColorStop(0,"rgba(80, 80, 80, 0.15)"),q.addColorStop(.5,"rgba(60, 60, 60, 0.08)"),q.addColorStop(1,"rgba(40, 40, 40, 0.02)"),n.globalAlpha=1,n.fillStyle=q,n.fillRect(0,0,a,a),n.globalAlpha=.06;for(let C=0;C<15;C++){const H=Math.random()*a,de=Math.random()*a,Q=Math.random()*2+1;n.fillStyle="#00ffaa",n.beginPath(),n.arc(H,de,Q,0,Math.PI*2),n.fill()}n.globalAlpha=1;const U=new lt(w);return U.wrapS=Me,U.wrapT=Me,U.repeat.set(6,6),U})(),Z=new $e({map:m,color:1710618,metalness:.05,roughness:.3,envMapIntensity:1.2}),K=new te(G,Z);K.rotation.x=-Math.PI/2,K.position.y=-2,K.receiveShadow=!0,f.add(K);const he=(()=>{const w=document.createElement("canvas"),a=1024;w.width=a,w.height=a;const n=w.getContext("2d");n.fillStyle="#f8f8f8",n.fillRect(0,0,a,a);const I=64,O=2;n.strokeStyle="#e0e0e0",n.lineWidth=O;for(let U=0;U<=a;U+=I)n.beginPath(),n.moveTo(U,0),n.lineTo(U,a),n.stroke();for(let U=0;U<=a;U+=I)n.beginPath(),n.moveTo(0,U),n.lineTo(a,U),n.stroke();const q=new lt(w);return q.wrapS=Me,q.wrapT=Me,q.repeat.set(4,4),q})(),T=new te(new je(y,z),new ke({map:he,color:16777215,transparent:!1,side:Ee}));T.rotation.x=Math.PI/2,T.position.y=8,T.receiveShadow=!0,f.add(T);const _=new ke({color:16316664,side:Re,transparent:!1}),V=32,ve=72,v=12,u=.5,x=new te(new ae(V,v,u),_);x.position.set(0,3,-36),x.receiveShadow=!0,x.castShadow=!1,h.add(x),f.add(x);const b=new te(new ae(10,v,u),_);b.position.set(-11,3,36),b.receiveShadow=!0,b.castShadow=!1,h.add(b),f.add(b);const o=new te(new ae(10,v,u),_);o.position.set(11,3,36),o.receiveShadow=!0,o.castShadow=!1,h.add(o),f.add(o);const r=new te(new ae(u,v,ve),_);r.position.set(-16,3,0),r.receiveShadow=!0,r.castShadow=!1,h.add(r),f.add(r);const c=new te(new ae(u,v,ve),_);c.position.set(16,3,0),c.receiveShadow=!0,c.castShadow=!1,h.add(c),f.add(c)},B=(f,h=null)=>{if(!E||E.length===0){for(let v=0;v<6;v++){const u=new je(3,2),x=new ke({color:6710886}),b=new te(u,x);v<3?(b.position.set(-6+v*6,3,-14.9),b.rotation.y=0):(b.position.set(-14.9,3,-6+(v-3)*6),b.rotation.y=Math.PI/2),f.add(b)}return}const y=Math.min(E.length,22),z=2.2,G=4,A=async()=>{const v=[];for(let b=0;b<Math.min(E.length,y);b++){const o=E[b];if(o.src||o.thumbnail)try{let r,c;o.aspectRatio&&o.dimensions?(r=o.aspectRatio,c=o.dimensions,console.log(`✅ 使用预计算尺寸: ${o.id} - ${c.width}x${c.height} (${r.toFixed(2)})`)):(console.log(`⚠️ 缺少预计算尺寸，动态检测: ${o.id}`),c=await K(o.src||o.thumbnail),r=c.width/c.height),v.push({index:b,item:o,aspectRatio:r,isPortrait:r<.8,isLandscape:r>1.3,isSquare:r>=.8&&r<=1.3,dimensions:c,isPrecomputed:!!(o.aspectRatio&&o.dimensions)})}catch(r){console.warn(`❌ 图片尺寸分析失败: ${o.id}`,r),v.push({index:b,item:o,aspectRatio:1,isPortrait:!1,isLandscape:!1,isSquare:!0,dimensions:{width:300,height:200},isPrecomputed:!1})}}const u=v.filter(b=>b.isPrecomputed).length,x=v.length;return console.log(`📊 尺寸分析完成: ${u}/${x} 使用预计算数据 (${Math.round(u/x*100)}%)`),v},m=v=>{const u={backWall:[],rightWall:[],leftWall:[],frontWall:[]},x=v.filter(w=>w.item.position!=="lightbox"),b=x.filter(w=>w.item.wall==="vertical_wall_32m"),o=x.filter(w=>w.item.wall==="horizontal_wall_64m"),r=o.filter(w=>w.item.layer==="upper"),c=o.filter(w=>w.item.layer==="lower");return u.backWall=b.slice(0,3),u.frontWall=b.slice(3,5),u.rightWall=[...r.slice(0,4),...c.slice(0,4)],u.leftWall=[...r.slice(4,8),...c.slice(4,8)],u},Z=async()=>{if(f.children.some(r=>r.name&&r.name.startsWith("painting_"))){console.log("⏭️ 跳过重复创建画作（画作已存在）");return}console.log("🎨 开始创建画廊画作...");const v=await A(),u=m(v),x=new Map,b=async(r,c,w)=>{var Se,Ae,ze,oe;const a=r.item,n=r.aspectRatio;let I,O;n>1.5?(I=Math.min(G,z*n*.8),O=I/n):n<.7?(O=z,I=O*n):(O=z*.9,I=O*n);const q=new je(I,O),U=new Oe({color:16777215,metalness:0,roughness:.15,clearcoat:.1,clearcoatRoughness:.1,reflectivity:.3,emissive:1052688,emissiveIntensity:.02,side:Ee}),C=new te(q,U),H=ve(C,I,O),de=35.5;switch(c){case"backWall":H.position.set(-10+w*10,2.4,-35.5),H.rotation.y=0;break;case"rightWall":{const{x:L,y:S,z:X}=$(r.item,u.rightWall);H.position.set(L,S,X),H.rotation.y=-Math.PI/2;break}case"leftWall":{const{x:L,y:S,z:X}=he(r.item,u.leftWall);H.position.set(L,S,X),H.rotation.y=Math.PI/2;break}case"frontWall":w===0?H.position.set(-10,2.4,de):H.position.set(10,2.4,de),H.rotation.y=Math.PI;break}H.castShadow=!1,H.receiveShadow=!1,H.name=`painting_${c}_${w}`,f.add(H),Ye.current.push({mesh:H,position:H.position.clone(),painting:C}),ge.current.set(a.id,{position:H.position.clone(),item:a,mesh:H}),setTimeout(()=>{(c==="frontWall"||c==="rightWall"&&r.item.layer==="lower"||c==="leftWall"&&r.item.layer==="lower")&&T(H)},100);const Q=a.src||a.thumbnail,ne=Q.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,"");if(console.log(`🔍 查找纹理 - item.id: ${a.id}, 预加载纹理数量: ${((Se=ue.current)==null?void 0:Se.textures.size)||0}`),console.log("🔍 预加载纹理keys:",Array.from(((Ae=ue.current)==null?void 0:Ae.textures.keys())||[])),(ze=ue.current)!=null&&ze.textures.has(a.id)){const L=ue.current.textures.get(a.id);C.material.map=L,C.material.color.setHex(16777215),C.material.needsUpdate=!0,console.log(`✅ 使用预加载Gallery纹理: ${a.id}`)}else if((oe=ue.current)!=null&&oe.videos.has(a.id)){const L=ue.current.videos.get(a.id);if(C.material.map=L,C.material.color.setHex(16777215),C.material.needsUpdate=!0,console.log(`✅ 使用预加载视频纹理: ${a.id}`),L.image){const S=L.image;S.paused&&S.play().catch(X=>{console.warn("Gallery视频自动播放失败，添加用户交互监听:",X);const Y=()=>{S.paused&&S.play().then(()=>{console.log(`🎬 Gallery视频用户交互后开始播放: ${a.id}`)}).catch(De=>console.warn("用户交互后播放失败:",De))};document.addEventListener("click",Y,{once:!0}),document.addEventListener("touchstart",Y,{once:!0})})}}else if(x.has(Q))C.material.map=x.get(Q),C.material.color.setHex(16777215),C.material.needsUpdate=!0;else try{if(a.type==="video"){const L=document.createElement("video");L.src=Q,L.autoplay=a.autoplay||!0,L.loop=a.loop||!0,L.muted=a.muted||!0,L.controls=a.controls||!1,L.crossOrigin="anonymous",L.playsInline=!0,await new Promise((X,Y)=>{L.oncanplay=X,L.onerror=Y,L.load()});const S=new at(L);S.generateMipmaps=!1,S.minFilter=Te,S.magFilter=Te,S.flipY=!0,S.colorSpace=Fe,x.set(Q,S),C.material.map=S,C.material.color.setHex(16777215),C.material.needsUpdate=!0,L.play().catch(X=>{console.warn("视频自动播放失败，需要用户交互:",X)}),console.log(`🎬 加载视频纹理: ${a.title.zh||a.title.en}`)}else{let L;a.id==="gallery_lightbox"?L=a.src.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,""):L=a.id.replace(/_/g,"-"),console.log(`⚠️ 预加载纹理不可用，尝试单独加载: ${a.id} -> ${L}`);const S=await be.loadSceneTextures("gallery",{images:[L],folder:"gallery"});if(S.textures.has(L)){const X=S.textures.get(L);x.set(Q,X),C.material.map=X,C.material.color.setHex(16777215),C.material.needsUpdate=!0,console.log(`✅ 单独加载Gallery纹理成功: ${L}`)}else throw new Error(`纹理加载失败: ${L}`)}}catch(L){console.warn(`Gallery纹理加载失败: ${ne}`,L),C.material.color.setHex(6710886),C.material.needsUpdate=!0}},o=[...u.backWall.map((r,c)=>({data:r,wallType:"backWall",index:c})),...u.rightWall.map((r,c)=>({data:r,wallType:"rightWall",index:c})),...u.leftWall.map((r,c)=>({data:r,wallType:"leftWall",index:c})),...u.frontWall.map((r,c)=>({data:r,wallType:"frontWall",index:c}))];for(let r=0;r<o.length;r+=4){const c=o.slice(r,r+4);await Promise.all(c.map(({data:w,wallType:a,index:n})=>b(w,a,n))),r+4<o.length&&await new Promise(w=>setTimeout(w,100))}console.log("🎨 所有画作纹理加载完成，触发加载管理器回调"),h&&h.onLoad&&setTimeout(()=>{h.onLoad()},200)},K=async v=>{try{const u=v.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,""),x=await be.getOptimalPath(u,"gallery");return new Promise(b=>{const o=new Image;o.onload=()=>{b({width:o.width,height:o.height})},o.onerror=()=>{const r=new Image;r.onload=()=>{b({width:r.width,height:r.height})},r.onerror=()=>{b({width:300,height:200})},r.src=v},o.src=x})}catch{return new Promise(u=>{const x=new Image;x.onload=()=>{u({width:x.width,height:x.height})},x.onerror=()=>{u({width:300,height:200})},x.src=v})}},$=(v,u)=>{const c=[-28,-12,4,20],w=[-20,-4,12,28];if(v.layer==="upper"){const a=u.filter(n=>n.item.layer==="upper").findIndex(n=>n.item.id===v.id);return{x:15.5,y:1.8+1.2,z:w[a]||0}}else{const a=u.filter(n=>n.item.layer==="lower").findIndex(n=>n.item.id===v.id);return{x:15.5,y:1.8,z:c[a]||0}}},he=(v,u)=>{const b=$(v,u);return{x:-15.5,y:b.y,z:-b.z}},T=v=>{const u=v.position,x=v.rotation,b=Math.abs(x.y)<.1||Math.abs(x.y-Math.PI)<.1;let o,r,c,w;b?(o=Math.PI/9,r=.08,c=12,w=6):(o=Math.PI/6,r=.15,c=15,w=3.5);const a=new Ke(16775393,1.5,c,o,r,1);let n=new ct;const I=Math.max(7,u.y+w),O=1.8;return Math.abs(x.y)<.1?n.set(u.x,I,u.z+O):Math.abs(x.y-Math.PI)<.1?n.set(u.x,I,u.z-O):Math.abs(x.y+Math.PI/2)<.1?n.set(u.x-O,I,u.z):Math.abs(x.y-Math.PI/2)<.1&&n.set(u.x+O,I,u.z),a.position.copy(n),a.target=v,a.castShadow=!1,a.userData={paintingPosition:u.clone(),baseIntensity:1,maxIntensity:8,activationDistance:6,optimalDistance:2},f.add(a),f.add(a.target),Ve.current.push(a),a},_=.05,V=.1,ve=(v,u=2.5,x=2)=>{const b=new rt,o=new Oe({color:1710618,metalness:.8,roughness:.2,clearcoat:.3,clearcoatRoughness:.1,emissive:657930,emissiveIntensity:.05}),r=[new ae(u+V*2,V,_),new ae(u+V*2,V,_),new ae(V,x,_),new ae(V,x,_)],c=[{x:0,y:(x+V)/2,z:_/2},{x:0,y:-(x+V)/2,z:_/2},{x:-(u+V)/2,y:0,z:_/2},{x:(u+V)/2,y:0,z:_/2}];return r.forEach((w,a)=>{const n=new te(w,o);n.position.set(c[a].x,c[a].y,c[a].z),n.castShadow=!1,n.receiveShadow=!1,b.add(n)}),b.add(v),b};Z()},xe=(f,h)=>{const y=6*f,z=ye.current,G=z.position.clone();(J.current.w||J.current.ArrowUp)&&h.moveForward(y),(J.current.s||J.current.ArrowDown)&&h.moveForward(-y),(J.current.d||J.current.ArrowRight)&&h.moveRight(y),(J.current.a||J.current.ArrowLeft)&&h.moveRight(-y),we(z)&&z.position.copy(G),((m,Z)=>{if(!Z.isLocked)return;let K=null,$=1/0;const he=4;if(ge.current.forEach(T=>{const _=m.position.distanceTo(T.position);_<he&&_<$&&($=_,K=T)}),K){const T=K.position.y,_=m.position.y,V=T-_;m.position.y+=V*.15}else{const V=2.4-m.position.y;m.position.y+=V*.08}m.position.y=Math.max(1.2,Math.min(3.5,m.position.y))})(z,h),h.isLocked||(z.position.y=2.4),Ie(z.position)},we=f=>{const h=f.position,y=14.5,z=34.5;if(h.x>y||h.x<-y||h.z>z||h.z<-z)return!0;const G=[{x:-5,z:18,radius:.5},{x:5,z:18,radius:.5},{x:0,z:-18,radius:1.618/2}],A=.5;for(const m of G)if(Math.sqrt(Math.pow(h.x-m.x,2)+Math.pow(h.z-m.z,2))<m.radius+A)return!0;return!1},Ie=f=>{Ve.current.forEach(h=>{const y=h.userData;if(!y||!y.paintingPosition)return;const z=f.distanceTo(y.paintingPosition);let G=y.baseIntensity;if(z<=y.activationDistance){const A=Math.max(0,(y.activationDistance-z)/y.activationDistance),m=y.maxIntensity-y.baseIntensity,Z=Math.pow(A,1.5);G=y.baseIntensity+m*Z,z<=y.optimalDistance&&(G=y.maxIntensity)}h.intensity=_e.lerp(h.intensity,G,.12)}),st(f)},st=f=>{const h=qe.current;if(!h)return;let y=1/0;Ye.current.forEach(G=>{const A=f.distanceTo(G.position);A<y&&(y=A)});const z=ye.current;if(z){const G=new ct;z.getWorldDirection(G);const A=z.position.clone().add(G.multiplyScalar(10));h.target.position.copy(A),h.target.updateMatrixWorld()}if(y<=6){const A=3+Math.max(0,(6-y)/6)*12;h.intensity=_e.lerp(h.intensity,A,.1)}else h.intensity=_e.lerp(h.intensity,1.5,.1)},nt=()=>{const f=ye.current;if(!f)return;const h={phase1:{duration:2500,startPos:{x:0,y:2.4,z:15},endPos:{x:0,y:2.4,z:12},startLookAt:{x:0,y:8,z:0},endLookAt:{x:0,y:8,z:0}},phase2:{duration:3e3,startPos:{x:0,y:2.4,z:12},endPos:{x:0,y:2.4,z:5},startLookAt:{x:0,y:8,z:0},endLookAt:{x:0,y:4,z:0}},phase3:{duration:2e3,startPos:{x:0,y:2.4,z:5},endPos:{x:0,y:2.4,z:0},startLookAt:{x:0,y:4,z:0},endLookAt:{x:0,y:2.4,z:-1}}};f.position.set(h.phase1.startPos.x,h.phase1.startPos.y,h.phase1.startPos.z),f.lookAt(h.phase1.startLookAt.x,h.phase1.startLookAt.y,h.phase1.startLookAt.z);let y=1,z=Date.now();const G=m=>{const Z=Date.now()-z,K=Math.min(Z/m.duration,1),$=K<.5?4*K*K*K:1-Math.pow(-2*K+2,3)/2;f.position.x=m.startPos.x+(m.endPos.x-m.startPos.x)*$,f.position.y=m.startPos.y+(m.endPos.y-m.startPos.y)*$,f.position.z=m.startPos.z+(m.endPos.z-m.startPos.z)*$;const he={x:m.startLookAt.x+(m.endLookAt.x-m.startLookAt.x)*$,y:m.startLookAt.y+(m.endLookAt.y-m.startLookAt.y)*$,z:m.startLookAt.z+(m.endLookAt.z-m.startLookAt.z)*$};return f.lookAt(he.x,he.y,he.z),K>=1},A=()=>{let m=!1;switch(y){case 1:m=G(h.phase1),m&&(y=2,z=Date.now());break;case 2:m=G(h.phase2),m&&(y=3,z=Date.now());break;case 3:if(m=G(h.phase3),m){l(!0),t(!1),setTimeout(()=>{d(!0)},9e3),F.current&&(F.current.getObject().position.copy(f.position),F.current.connect=F.current.connect.__original||F.current.connect);return}break}pt.current=requestAnimationFrame(A)};A()};return(async()=>{try{if(le.current||me.current)return;const f=new St;ft.current=f;let h=!1;const y=async()=>{try{const o=[],r=[];E.slice(0,12).forEach(n=>{let I;n.id==="gallery_lightbox"?I=n.src.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,""):I=n.id.replace(/_/g,"-"),n.type==="video"?r.push({id:n.id,fileName:I,src:n.src}):o.push({id:n.id,fileName:I})}),console.log("🎨 开始预加载Gallery纹理...",{images:o.length,videos:r.length});const c=await be.loadSceneTextures("gallery",{images:o.map(n=>n.fileName),videos:r.map(n=>({name:n.fileName,src:n.src})),folder:"gallery",onProgress:(n,I,O)=>{console.log(`📦 Gallery纹理加载进度: ${I}/${O} (${Math.round(n*100)}%)`)}}),w=new Map,a=new Map;o.forEach(({id:n,fileName:I})=>{c.textures.has(I)&&w.set(n,c.textures.get(I))}),r.forEach(({id:n,fileName:I})=>{c.videos.has(I)&&a.set(n,c.videos.get(I))}),ue.current={textures:w,videos:a,errors:c.errors},console.log(`✅ Gallery纹理预加载完成: ${c.textures.size}张图片, ${c.videos.size}个视频`),c.errors.length>0&&console.warn("⚠️ 部分Gallery纹理加载失败:",c.errors),h=!0,z&&h&&G()}catch(o){console.warn("Gallery纹理预加载失败，使用fallback:",o),ue.current={textures:new Map,videos:new Map,errors:[]},h=!0,z&&G()}};let z=!1;const G=()=>{requestAnimationFrame(()=>{me.current&&le.current&&ye.current?(me.current.render(le.current,ye.current),requestAnimationFrame(()=>{setTimeout(()=>{nt()},300)})):setTimeout(()=>{nt()},500)})};f.onLoad=()=>{console.log("🎭 THREE.js场景加载完成"),z=!0,h&&G()},f.onError=()=>{},y();const A=new kt;A.background=new re(1710618),le.current=A;const m=new Mt(75,j.clientWidth/j.clientHeight,.1,1e3);m.position.set(0,2.4,0),ye.current=m;const Z=new Ke(16774374,6,15,Math.PI/5,.15,1.2);Z.position.set(0,0,0),Z.castShadow=!1;const K=new Lt;Z.target=K,m.add(Z),A.add(K),A.add(m),qe.current=Z;const $=new Pt({antialias:!0,alpha:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1});if($.setSize(j.clientWidth,j.clientHeight),$.setClearColor(15790320,1),$.shadowMap.enabled=!0,$.shadowMap.type=It,$.outputColorSpace=Fe,$.toneMapping=At,$.toneMappingExposure=1,!$.getContext())throw new Error("WebGL context creation failed");j.appendChild($.domElement),me.current=$;let T;try{document&&document.body&&document.documentElement&&window.self===window.top&&"requestPointerLock"in document.body?T=new Be(m,document.body):(T=new Be(m,$.domElement),console.warn("Pointer Lock API not available, using fallback mode"))}catch(o){console.warn("PointerLockControls initialization failed:",o),T=new Be(m,$.domElement)}A.add(T.getObject()),F.current=T;try{T.addEventListener("lock",()=>{D(!0)}),T.addEventListener("unlock",()=>{D(!1)})}catch(o){console.warn("PointerLockControls event setup failed:",o)}try{const o=T.connect;o&&(T.connect.__original=o,T.connect=()=>{if(s)try{o.call(T)}catch(r){console.warn("PointerLockControls connect failed:",r)}})}catch(o){console.warn("PointerLockControls connect override failed:",o)}const _=o=>{const c=(()=>{const I=new ae(12,12,.4),O=new Oe({color:1710618,metalness:.9,roughness:.1,clearcoat:.5,clearcoatRoughness:.05,emissive:3355443,emissiveIntensity:.15}),q=new te(I,O);q.position.set(0,3,35.8),o.add(q);const C=(()=>{const Q=new je(11,9),ne={useVideo:!0,videoPath:"/ui-test.mp4",imagePath:"/gallery/gallery-vertical-0.jpg"},Se=E.find(S=>S.position==="lightbox"),Ae=Se?Se.src||Se.thumbnail:ne.imagePath;let ze;ne.useVideo&&(ze=new ke({color:0,emissive:0,emissiveIntensity:0,transparent:!0,opacity:.95,side:Re}));const oe=new te(Q,ze);if(oe.position.set(0,3,36-.4-.02),oe.rotation.y=Math.PI,oe.name="LightboxGallery",o.add(oe),ne.useVideo){console.log(`🎬 Lightbox视频加载: ${ne.videoPath}`);const S=document.createElement("video");S.src=ne.videoPath,S.crossOrigin="anonymous",S.loop=!0,S.muted=!0,S.autoplay=!0,S.playsInline=!0,S.preload="auto";const X=()=>{try{const Y=new at(S);Y.minFilter=Te,Y.magFilter=Te,Y.format=zt,Y.generateMipmaps=!1,Y.flipY=!0,Y.colorSpace=Fe;const De=new ke({map:Y,emissive:0,emissiveIntensity:0,transparent:!1,side:Re});oe.material.dispose(),oe.material=De,console.log("✅ Lightbox视频纹理设置完成"),S.play().catch(yt=>{console.warn("Lightbox视频自动播放失败:",yt)})}catch(Y){console.warn("Lightbox视频纹理创建失败:",Y)}};S.addEventListener("loadeddata",X),S.addEventListener("canplay",X),S.addEventListener("loadedmetadata",()=>{S.play().catch(()=>{console.warn("Lightbox视频元数据加载后播放失败")})}),S.addEventListener("error",Y=>{console.warn("Lightbox视频加载错误:",Y),L()}),S.load()}function L(){console.log(`🖼️ Lightbox图片加载: ${Ae}`);const S=Ae.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,"");be.loadTexture(S).then(X=>{const Y=new ke({map:X,emissive:0,emissiveIntensity:0,transparent:!0,opacity:.61,side:Re});oe.material.dispose(),oe.material=Y,console.log("✅ Lightbox图片纹理设置完成")}).catch(()=>{console.warn("Lightbox图片加载失败，保持占位材质")})}return{screen:oe}})();return console.log("🖼️ Lightbox屏幕创建完成",C),{lightBox:q,lightboxDisplay:C}})();return{wallLightBox:c.lightBox,lightboxDisplay:c.lightboxDisplay.screen,ledFrame:c.lightboxDisplay.frame}},V=()=>{const o=[];return[{start:{x:-3,z:2.25},end:{x:3,z:2.25},name:"王-上横"},{start:{x:-2.5,z:0},end:{x:2.5,z:0},name:"王-中横"},{start:{x:-3.5,z:-2.25},end:{x:3.5,z:-2.25},name:"王-下横"},{start:{x:0,z:2.25},end:{x:0,z:-2.25},name:"王-竖线"}].forEach(c=>{const w=Math.sqrt(Math.pow(c.end.x-c.start.x,2)+Math.pow(c.end.z-c.start.z,2));let a;c.name.includes("竖")?a=new ae(.4,.2,w):a=new ae(w,.2,.4);const n=new $e({color:16777215,emissive:16777215,emissiveIntensity:2,transparent:!1}),I=new te(a,n),O=(c.start.x+c.end.x)/2,q=(c.start.z+c.end.z)/2;I.position.set(O,6,q),A.add(I);const U=new ht(16777215,7,45);U.position.set(O,5.5,q),A.add(U),o.push({tube:I,name:c.name})}),o},ve=_(A);console.log("🎨 艺术元素创建完成:",ve),V(),ce(A),B(A,f);const v=()=>{try{const o={intensity:4,colors:[16739179,5164484,4569041,16370212],showHelpers:!1,enableAnimation:!0,animationSpeed:8e-4,lightWidth:8,lightHeight:6,positions:[{x:-30,y:10,z:0,rx:0,ry:Math.PI/2,rz:0},{x:30,y:10,z:0,rx:0,ry:-Math.PI/2,rz:0},{x:0,y:11.5,z:30,rx:-Math.PI/3,ry:0,rz:0},{x:0,y:11.5,z:-10,rx:-Math.PI/3,ry:Math.PI,rz:0}]};Le.current=new $t(A,o),Le.current.setPreset("soft"),console.log("RectAreaLighting系统初始化成功")}catch(o){console.warn("RectAreaLighting初始化失败:",o)}},u=async()=>{try{const o={cubeSize:2.5,cubeCount:3,spacing:10,height:6,intensity:2.5,lightSize:2,enableAnimation:!0,animationSpeed:.001,showCubeMesh:!0,cubeOpacity:.05,showHelpers:!1};Pe.current=new Nt(A,o,E),await Pe.current.init(),console.log("光柱系统初始化成功")}catch(o){console.warn("光柱系统初始化失败:",o)}},x=()=>{try{const o={lightCount:3,intensity:4200,distance:80,angle:Math.PI/1.8,penumbra:.4,enableAnimation:!0,animationSpeed:.3,showHelpers:!1};We.current=new Wt(A,$,o),console.log("✨ 3灯位IES聚光灯系统初始化成功 - 避开lightbox墙面")}catch(o){console.warn("⚠️ IES聚光灯系统初始化失败:",o)}};setTimeout(()=>{v(),setTimeout(async()=>{await u(),setTimeout(()=>{x()},200)},100)},300);const b=()=>{Ne.current=requestAnimationFrame(b);const o=ut.current.getDelta();T.isLocked&&xe(o,T),A.traverse(r=>{r.material&&r.material.map&&r.material.map.isVideoTexture&&(r.material.map.needsUpdate=!0)}),$.render(A,m)};b(),t(!1)}catch(f){throw t(!1),f}})().catch(f=>{console.error("Gallery场景初始化失败:",f),t(!1)}),()=>{var f;(f=F.current)!=null&&f.isLocked&&(console.log("🔓 Gallery组件卸载时强制解锁指针"),F.current.unlock()),D(!1),Le.current&&(Le.current.dispose(),Le.current=null,console.log(" 🧹 RectAreaLighting系统已清理")),Pe.current&&(Pe.current.dispose(),Pe.current=null,console.log(" 🏛️ 发光圆柱体系统已清理")),We.current&&(We.current.dispose(),We.current=null,console.log(" 🧹 IES聚光灯系统已清理")),Ne.current&&(cancelAnimationFrame(Ne.current),Ne.current=null),F.current&&(F.current.isLocked&&F.current.unlock(),F.current.dispose(),F.current=null,console.log(" 🎮 Gallery控制器已清理")),le.current&&(le.current.traverse(h=>{h.geometry&&h.geometry.dispose(),h.material&&(Array.isArray(h.material)?h.material.forEach(y=>{y.map&&y.map.dispose(),y.normalMap&&y.normalMap.dispose(),y.roughnessMap&&y.roughnessMap.dispose(),y.dispose()}):(h.material.map&&h.material.map.dispose(),h.material.normalMap&&h.material.normalMap.dispose(),h.material.roughnessMap&&h.material.roughnessMap.dispose(),h.material.dispose()))}),le.current.clear(),le.current=null),me.current&&(j&&j.contains(me.current.domElement)&&j.removeChild(me.current.domElement),me.current.dispose(),me.current=null),ye.current=null,Ue.current=null,console.log("🧹 Gallery 组件清理完成")}},[E,s,D]),M.useEffect(()=>{const j=()=>{var B;!(document.pointerLockElement!==null)&&((B=F.current)!=null&&B.isLocked)&&(console.log("🔓 检测到指针锁定状态不一致，强制同步状态"),F.current&&(F.current.disconnect(),setTimeout(()=>{F.current&&F.current.connect()},100)),D(!1))};return document.addEventListener("pointerlockchange",j),document.addEventListener("pointerlockerror",j),()=>{document.removeEventListener("pointerlockchange",j),document.removeEventListener("pointerlockerror",j)}},[D]),M.useEffect(()=>{const j=B=>{var we,Ie;if((we=F.current)!=null&&we.isLocked&&!["KeyW","KeyA","KeyS","KeyD","Escape"].includes(B.code)&&B.key!=="Escape"){B.preventDefault(),B.stopPropagation(),console.log("🔒 画廊导航模式：只允许WASD移动和ESC退出");return}const xe=B.code==="KeyW"?"w":B.code==="KeyA"?"a":B.code==="KeyS"?"s":B.code==="KeyD"?"d":B.key.toLowerCase();xe in J.current&&(J.current[xe]=!0),B.key==="Escape"&&((Ie=F.current)!=null&&Ie.isLocked)&&(console.log("🔓 ESC键解锁指针"),F.current.unlock())},ce=B=>{var we;if((we=F.current)!=null&&we.isLocked&&!["KeyW","KeyA","KeyS","KeyD"].includes(B.code)){B.preventDefault(),B.stopPropagation();return}const xe=B.code==="KeyW"?"w":B.code==="KeyA"?"a":B.code==="KeyS"?"s":B.code==="KeyD"?"d":B.key;xe in J.current&&(J.current[xe]=!1)};return document.addEventListener("keydown",j),document.addEventListener("keyup",ce),()=>{document.removeEventListener("keydown",j),document.removeEventListener("keyup",ce)}},[]),i.jsxs(i.Fragment,{children:[N&&ie&&i.jsx("div",{className:"fixed inset-0 z-[99999] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4",children:i.jsxs("div",{className:"bg-white/10 backdrop-blur-md rounded-2xl p-8 text-center max-w-md border border-white/20",children:[i.jsxs("div",{className:"mb-6",children:[i.jsx("svg",{className:"w-16 h-16 text-yellow-400 mx-auto mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:i.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"})}),i.jsx("h3",{className:"text-2xl font-bold text-white mb-2",children:p==="zh"?"移动端体验提示":"Mobile Experience Notice"}),i.jsx("p",{className:"text-white/80 leading-relaxed",children:p==="zh"?"3D 画廊采用第一人称漫游技术，需要键盘和鼠标操作，移动端体验可能不佳。建议使用桌面设备以获得最佳浏览效果。":"The 3D gallery uses first-person navigation technology requiring keyboard and mouse controls. For the best experience, Hua recommend using a desktop device."})]}),i.jsxs("div",{className:"space-y-3",children:[i.jsx("button",{onClick:()=>{ee(!1),k(!0)},className:"w-full bg-theme-primary/20 hover:bg-theme-primary/30 text-theme-primary border border-theme-primary/30 hover:border-theme-primary/50 py-3 px-6 rounded-lg transition-all duration-300",children:p==="zh"?"继续浏览图片集":"View Image Gallery"}),i.jsx("p",{className:"text-white/60 text-sm",children:p==="zh"?"或在桌面设备上体验完整的 3D 画廊":"Or visit on desktop for the full 3D gallery experience"})]})]})}),N&&se&&i.jsx(mt,{language:p,texts:P}),!N&&i.jsxs("section",{id:"gallery",className:"min-h-screen flex flex-col justify-center items-center bg-gray-100 relative overflow-hidden",children:[(e||!s)&&i.jsx(dt,{size:160,strokeWidth:12,showMask:!0,maskColor:"black-solid"}),i.jsx("div",{ref:fe,className:`w-full h-screen relative bg-gray-200 ${e||!s?"invisible":"visible"}`,style:{minHeight:"100vh"}}),i.jsxs("div",{className:`absolute bottom-6 left-6 bg-black/50 backdrop-blur-md rounded-xl p-4 text-white z-20 max-w-sm transition-all duration-1000 ${!e&&s&&g&&!R?"opacity-100 translate-y-0":"opacity-0 translate-y-4 pointer-events-none"}`,children:[i.jsx("p",{className:"text-lg font-medium mb-3",children:p==="zh"?"如何操作？":"How to Play?"}),i.jsxs("div",{className:"space-y-3 text-sm",children:[i.jsxs("p",{className:"flex items-center",children:[i.jsx("span",{className:"w-2"}),p==="zh"?"点击进入长廊":"Click to enter the gallery"]}),i.jsxs("p",{className:"flex items-center",children:[i.jsx("span",{className:"w-2"}),p==="zh"?"鼠标 - 环视周围，探索画作":"Mouse - Look around and explore"]}),i.jsxs("p",{className:"flex items-center",children:[i.jsx("span",{className:"w-2"}),i.jsxs("span",{className:"inline-flex items-center gap-1 mr-2",children:[i.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono border border-white/30",children:"W"}),i.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono border border-white/30",children:"A"}),i.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono border border-white/30",children:"S"}),i.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono border border-white/30",children:"D"})]}),i.jsx("span",{children:p==="zh"?"移动穿行长廊":"Move through the gallery"})]}),i.jsxs("p",{className:"flex items-center",children:[i.jsx("span",{className:"w-2"}),i.jsx("span",{className:"inline-flex items-center px-2 py-0.5 mr-2 bg-white/20 rounded text-xs font-mono border border-white/30",children:"ESC"}),i.jsx("span",{children:p==="zh"?"退出指针锁定模式":"Exit pointer lock mode"})]})]})]}),i.jsx("div",{className:`absolute inset-0 flex items-center justify-center cursor-pointer z-10 transition-all duration-1000 ${!e&&s&&g&&!R?"opacity-100 scale-100":"opacity-0 scale-95 pointer-events-none"}`,onClick:()=>{var j;if(!e&&s&&g&&!R)if((j=F.current)!=null&&j.lock)try{F.current.lock(),setTimeout(()=>{R||(console.log("Fallback: manually setting pointer locked state"),D(!0))},100)}catch(ce){console.log("Pointer lock failed, using fallback:",ce.message),D(!0)}else D(!0)},children:i.jsxs("div",{className:"bg-white/10 backdrop-blur-md rounded-2xl p-8 text-center transition-all duration-300 border border-white/20 hover:bg-white/20 hover:scale-105",children:[i.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:((Je=(Ze=(Xe=P[p])==null?void 0:Xe.gallery)==null?void 0:Ze.gallery3D)==null?void 0:Je.title)||"浮生长廊"}),i.jsx("p",{className:"text-white/80 mb-6",children:((it=(tt=(et=(Qe=P[p])==null?void 0:Qe.gallery)==null?void 0:et.gallery3D)==null?void 0:tt.instructions)==null?void 0:it.clickToStart)||"点击进入"}),i.jsx("div",{className:"animate-bounce",children:i.jsxs("svg",{className:"w-8 h-8 text-white mx-auto",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[i.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),i.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})]})}),R&&i.jsx(i.Fragment,{children:i.jsxs("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-20",children:[i.jsx("div",{className:"w-2 h-2 bg-white rounded-full shadow-lg border border-white/30"}),i.jsx("div",{className:"absolute w-6 h-0.5 bg-white/60 rounded shadow-sm"}),i.jsx("div",{className:"absolute w-0.5 h-6 bg-white/60 rounded shadow-sm"}),i.jsx("div",{className:"absolute w-8 h-8 border border-white/20 rounded-full"})]})})]})]})};gt.propTypes={language:pe.string};const Bt=Object.freeze(Object.defineProperty({__proto__:null,default:gt},Symbol.toStringTag,{value:"Module"}));export{dt as C,Bt as G,Ct as P,Et as u};
