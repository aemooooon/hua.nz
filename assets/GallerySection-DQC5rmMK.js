const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/three-CWe9OjjT.js","assets/vendor-rLp43SRl.js","assets/leaflet-BD0kuunB.js","assets/leaflet-BTrKGrB8.css","assets/vendor-DSulWsr7.css"])))=>i.map(i=>d[i]);
import{r as z,j as o}from"./react-CgIfOqKe.js";import{P as rt}from"./vendor-rLp43SRl.js";import{H as Re,J as ut,K as ft,T as et,C as Z,X as pt,Y as yt,M as q,g as lt,q as Ie,Z as ye,_ as pe,$ as He,a0 as Ge,a1 as xt,S as wt,b as bt,a2 as St,W as vt,a3 as kt,r as tt,a4 as Mt,a5 as Te,a6 as V,P as Me,t as Le,u as $e,a7 as it,k as nt,a8 as De,a9 as st,z as Lt,v as ot,j as at}from"./three-CWe9OjjT.js";import{u as ze,b as zt,_ as It}from"./index-DtktVB_K.js";import{C as At}from"./CircularLoadingIndicator-C-ojp_cu.js";import{t as Ae}from"./index-CnkmtyaF.js";import"./leaflet-BD0kuunB.js";const ct=({language:T="zh"})=>{const e=ze(w=>w.getAllGalleryItems()),{openPhotoSwipe:t}=zt(),s=z.useRef(null),h=z.useMemo(()=>Array.isArray(e)?e:[],[e]).map((w,G)=>({id:w.id||G,src:w.src,thumbnail:w.thumbnail||w.src,title:w.title||"",description:w.description||""})),p=w=>{t(h,w)};return o.jsxs(o.Fragment,{children:[o.jsx("style",{children:`
        .gallery-mobile-container {
          min-height: 100vh;
          max-height: 100vh;
          overflow-y: auto;
          overflow-x: hidden;
          overscroll-behavior: none;
          
          /* iOS 安全区域支持 */
          padding-top: max(1rem, env(safe-area-inset-top));
          padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
          padding-left: env(safe-area-inset-left);
          padding-right: env(safe-area-inset-right);
          
          /* 确保在iOS上平滑滚动 */
          -webkit-overflow-scrolling: touch;
          
          /* 防止选择文本 */
          -webkit-user-select: none;
          user-select: none;
          
          /* 确保触摸滚动正常工作 */
          touch-action: pan-y;
        }
        
        /* 自定义滚动条样式 */
        .gallery-mobile-container::-webkit-scrollbar {
          width: 4px;
        }
        .gallery-mobile-container::-webkit-scrollbar-track {
          background: transparent;
        }
        .gallery-mobile-container::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.2);
          border-radius: 2px;
        }
        .gallery-mobile-container::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.3);
        }
        
        /* 移动端特殊处理 */
        @media (max-width: 768px) {
          .gallery-mobile-container {
            /* 在移动设备上隐藏滚动条 */
            scrollbar-width: none;
            -ms-overflow-style: none;
          }
          
          .gallery-mobile-container::-webkit-scrollbar {
            display: none;
          }
          
          /* 确保图片点击区域可用 */
          .gallery-image-item {
            touch-action: manipulation;
          }
        }
      `}),o.jsxs("div",{ref:s,className:"gallery-mobile-container w-full",children:[o.jsxs("div",{className:"text-center mb-8 px-4",children:[o.jsx("h2",{className:"text-3xl md:text-4xl font-bold text-theme-text-primary mb-4",children:T==="zh"?"作品集":"Gallery"}),o.jsx("p",{className:"text-theme-text-secondary max-w-2xl mx-auto leading-relaxed",children:T==="zh"?"记录生活中的美好瞬间，每一张照片都承载着独特的故事与回忆。":"Capturing beautiful moments in life, each photo carries unique stories and memories."}),o.jsx("p",{className:"text-theme-text-secondary/60 text-sm mt-2",children:T==="zh"?"点击图片查看大图":"Tap images to view full size"})]}),o.jsxs("div",{className:"max-w-6xl mx-auto px-4",children:[o.jsx("div",{className:"grid grid-cols-3 gap-2 sm:gap-3 md:gap-4 pb-8",children:h.map((w,G)=>o.jsx("div",{onClick:()=>p(G),className:"group project-card cursor-pointer transform transition-all duration-300 active:scale-95",children:o.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden bg-theme-surface/10",children:[o.jsx("img",{src:w.thumbnail||w.src,alt:`Gallery item ${G+1}`,className:"w-full h-full object-cover",loading:"lazy",onError:ee=>{ee.target.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjMzMzIj48L3JlY3Q+PC9zdmc+"}}),o.jsx("div",{className:"absolute inset-0 bg-black/20 opacity-0 group-active:opacity-100 transition-opacity duration-200 flex items-center justify-center",children:o.jsx("div",{className:"w-8 h-8 border-2 border-white rounded-full flex items-center justify-center",children:o.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})}),o.jsx("div",{className:"absolute top-2 right-2 bg-black/50 backdrop-blur-sm rounded-full w-6 h-6 flex items-center justify-center text-white text-xs font-medium",children:G+1})]})},w.id))}),h.length===0&&o.jsxs("div",{className:"text-center py-16",children:[o.jsx("div",{className:"w-16 h-16 bg-theme-surface/20 rounded-full flex items-center justify-center mx-auto mb-4",children:o.jsx("svg",{className:"w-8 h-8 text-theme-text-secondary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),o.jsx("div",{className:"text-theme-text-secondary text-lg mb-2",children:T==="zh"?"暂无图片内容":"No gallery items available"}),o.jsx("div",{className:"text-theme-text-secondary/60 text-sm",children:T==="zh"?"请稍后再试":"Please try again later"})]}),h.length>0&&o.jsx("div",{className:"text-center mt-8 py-6",children:o.jsx("p",{className:"text-theme-text-secondary/60 text-sm",children:T==="zh"?`共 ${h.length} 张图片 • 点击查看大图`:`${h.length} images • Tap to view full size`})})]})]})]})};ct.propTypes={language:rt.string};class Pt{constructor(e,t={}){this.scene=e,this.rectLights=[],this.helpers=[],this.animationId=null,this.config={intensity:t.intensity||5,colors:t.colors||[16739179,5164484,4569041,16370212],showHelpers:t.showHelpers||!1,enableAnimation:t.enableAnimation!==!1,animationSpeed:t.animationSpeed||.001,lightWidth:t.lightWidth||6,lightHeight:t.lightHeight||8,positions:t.positions||[{x:-18,y:8,z:15,rx:0,ry:0,rz:0},{x:18,y:8,z:15,rx:0,ry:Math.PI,rz:0},{x:0,y:10,z:35,rx:-Math.PI/2,ry:0,rz:0},{x:0,y:10,z:-15,rx:-Math.PI/2,ry:Math.PI,rz:0}]},this.clock=new Re,this.init()}init(){ut.init(),this.createRectAreaLights(),this.config.enableAnimation&&this.startAnimation()}createRectAreaLights(){this.config.positions.forEach((e,t)=>{const s=this.config.colors[t%this.config.colors.length],c=new ft(s,this.config.intensity,this.config.lightWidth,this.config.lightHeight);if(c.position.set(e.x,e.y,e.z),c.rotation.set(e.rx,e.ry,e.rz),this.scene.add(c),this.rectLights.push(c),this.config.showHelpers){const h=new et(c);this.scene.add(h),this.helpers.push(h)}c.userData={originalIntensity:this.config.intensity,originalColor:new Z(s),animationPhase:t/this.config.positions.length*Math.PI*2,index:t}})}startAnimation(){const e=()=>{this.animationId=requestAnimationFrame(e),this.updateAnimation()};e()}updateAnimation(){const e=this.clock.getElapsedTime();this.rectLights.forEach((t,s)=>{const c=t.userData,h=Math.sin(e*this.config.animationSpeed*1e3+c.animationPhase);t.intensity=c.originalIntensity+h*2;const p=Math.sin(e*this.config.animationSpeed*500+c.animationPhase*2)*.1;switch(t.color.copy(c.originalColor),s){case 0:t.color.r=Math.max(.3,t.color.r+p);break;case 1:t.color.g=Math.max(.3,t.color.g+p),t.color.b=Math.max(.3,t.color.b+p);break;case 2:t.color.b=Math.max(.3,t.color.b+p);break;case 3:t.color.r=Math.max(.3,t.color.r+p),t.color.g=Math.max(.3,t.color.g+p);break}})}setIntensity(e){this.config.intensity=e,this.rectLights.forEach(t=>{t.userData.originalIntensity=e})}setAnimationSpeed(e){this.config.animationSpeed=e}toggleHelpers(){this.config.showHelpers=!this.config.showHelpers,this.config.showHelpers?this.rectLights.forEach(e=>{const t=new et(e);this.scene.add(t),this.helpers.push(t)}):(this.helpers.forEach(e=>{this.scene.remove(e)}),this.helpers=[])}setPreset(e){switch(e){case"warm":this.config.colors=[16739179,16370212,16752627,15620644],this.setIntensity(6),this.setAnimationSpeed(8e-4);break;case"cool":this.config.colors=[5164484,4569041,10837738,2547329],this.setIntensity(5),this.setAnimationSpeed(.0012);break;case"dramatic":this.config.colors=[16726072,3093826,16737096,8121759],this.setIntensity(8),this.setAnimationSpeed(.002);break;case"soft":this.config.colors=[16771751,14524637,10016968,16243823],this.setIntensity(3),this.setAnimationSpeed(5e-4);break}this.rectLights.forEach((t,s)=>{const c=this.config.colors[s%this.config.colors.length];t.userData.originalColor=new Z(c)})}toggleAnimation(){this.config.enableAnimation=!this.config.enableAnimation,this.config.enableAnimation?this.startAnimation():(this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.rectLights.forEach(e=>{e.intensity=e.userData.originalIntensity,e.color.copy(e.userData.originalColor)}))}getStatus(){return{intensity:this.config.intensity,animationSpeed:this.config.animationSpeed,enableAnimation:this.config.enableAnimation,showHelpers:this.config.showHelpers,lightCount:this.rectLights.length}}dispose(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.rectLights.forEach(e=>{this.scene.remove(e)}),this.rectLights=[],this.helpers.forEach(e=>{this.scene.remove(e)}),this.helpers=[]}}class Wt{generatePositionsFromGallery(e){return null}extractBaseName(e){return e?e.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,""):null}constructor(e,t={},s=[]){this.scene=e,this.galleryData=s,this.lightCylinders=[],this.animationId=null,this.textureLoader=new pt,this.roomConfig={floorY:-2,ceilingY:8,height:10},this.config={radius:t.radius||.5,height:this.roomConfig.height,radialSegments:t.radialSegments||32,heightSegments:t.heightSegments||1,cubeWidth:t.cubeWidth||1,cubeHeight:t.cubeHeight||8,cubeDepth:t.cubeDepth||1,cubeCount:t.cubeCount||3,enableTexture:t.enableTexture!==!1,textureUrl:t.textureUrl||null,textureDelay:t.textureDelay||1e3,baseColor:t.baseColor||16711744,enableGlow:t.enableGlow!==!1,glowIntensity:t.glowIntensity||.7,emissiveIntensity:t.emissiveIntensity||.3,positions:[{x:-5,z:24,color:65416,textureBaseName:null},{x:5,z:24,color:65535,textureBaseName:null},{x:0,z:-18,color:16711744,textureBaseName:"gallery-horizontal-11",radius:1.618,rotationY:Math.PI/1.5}],intensity:t.intensity||20,lightIntensity:t.lightIntensity||20,lightDistance:t.lightDistance||80,enableAnimation:t.enableAnimation!==!1,animationSpeed:t.animationSpeed||.001,colors:[65416,65535,16711744]},this.clock=new Re,this.lightCubes=this.lightCylinders}async init(){console.log("🏛️ 初始化发光圆柱体系统（从地板到天花板）..."),await this.preloadTextures(),this.createLightCylinders(),this.config.enableAnimation&&this.startAnimation()}async preloadTextures(){try{console.log("⏩ 跳过纹理预加载，使用按需加载策略")}catch(e){console.warn("⚠️ 纹理预加载失败，将使用原始路径:",e)}}createLightCubes(){this.createLightCylinders()}createLightCylinders(){this.config.positions.forEach((e,t)=>{this.createSingleLightCylinder(e,t)}),console.log(`✅ 所有 ${this.config.positions.length} 个发光圆柱体创建完成（纹理将延迟加载）`)}createSingleLightCube(e,t,s,c){const h={x:e,z:s,color:this.config.colors[c]||this.config.baseColor,textureBaseName:null};this.createSingleLightCylinder(h,c)}createSingleLightCylinder(e,t){const s={position:{x:e.x,y:2,z:e.z},mesh:null,light:null,index:t,config:e},c=e.radius||this.config.radius,h=this.config.height-.05,p=new yt(c,c,h,this.config.radialSegments,this.config.heightSegments),w=this.createCylinderMaterial(e,t),G=new q(p,w),ee=(this.roomConfig.floorY+this.roomConfig.ceilingY)/2;if(G.position.set(e.x,ee,e.z),e.rotationY!==void 0&&(G.rotation.y=e.rotationY,console.log(`🔄 柱子绕Y轴旋转: ${(e.rotationY*180/Math.PI).toFixed(1)}度`)),this.scene.add(G),s.mesh=G,s.position.y=ee,this.config.enableGlow){const ce=new lt(e.color,this.config.lightIntensity,this.config.lightDistance);ce.position.set(e.x,ee,e.z),this.scene.add(ce),s.light=ce}s.originalColor=new Z(e.color),s.originalIntensity=this.config.lightIntensity,s.animationPhase=t*Math.PI*.6,this.lightCylinders.push(s);const ge=["Lightbox前左侧柱子(32米墙的1/3位置，约-10.67米)","Lightbox前右侧柱子(32米墙的2/3位置，约10.67米)","摄像机背后红色柱子(从地板到天花板，黄金比例直径)"];console.log(`🏛️ 创建发光圆柱体 ${t+1}: ${ge[t]} 位置(${e.x}, ${ee}, ${e.z}), 高度${this.config.height}米, 半径${c}米, 直径${(c*2).toFixed(3)}米`),e.textureUrl&&console.log(`🖼️ 圆柱体 ${t+1} 应用贴图: ${e.textureUrl}`)}createCylinderMaterial(e,t){const s=e.color||this.config.baseColor,c=e.textureBaseName||this.config.textureBaseName;let h={transparent:!0,opacity:.9,side:Ie};h={...h,color:s,emissive:new Z(s).multiplyScalar(this.config.emissiveIntensity)};const p=new ye(h);return c&&this.config.enableTexture&&setTimeout(async()=>{try{console.log(`🖼️ 延迟加载圆柱体 ${t+1} 的纹理: ${c}`);const w=await this.loadGalleryTexture(c);w.repeat.set(1,1),p.map=w,p.color=new Z(1,1,1),p.needsUpdate=!0,console.log(`✅ 圆柱体 ${t+1} 纹理加载完成: ${c}`)}catch(w){console.warn(`❌ 圆柱体 ${t+1} 纹理加载失败: ${c}`,w)}},this.config.textureDelay||2e3),p}setTexture(e,t){if(e>=0&&e<this.lightCylinders.length){const s=this.lightCylinders[e];if(t){console.log(`🖼️ 为圆柱体 ${e+1} 设置新贴图: ${t}`);const c=this.textureLoader.load(t);c.wrapS=pe,c.wrapT=pe,c.repeat.set(1,1);const h=new ye({map:c,transparent:!0,opacity:.9,emissive:new Z(s.config.color).multiplyScalar(this.config.emissiveIntensity),side:Ie});s.mesh&&s.mesh.material&&(s.mesh.material.dispose(),s.mesh.material=h),console.log(`✅ 圆柱体 ${e+1} 贴图已应用，照明功能保持正常`)}else{console.log(`🔄 移除圆柱体 ${e+1} 的贴图，恢复发光效果`);const c=new ye({color:s.config.color,transparent:!0,opacity:.9,emissive:new Z(s.config.color).multiplyScalar(this.config.emissiveIntensity),side:Ie});s.mesh&&s.mesh.material&&(s.mesh.material.dispose(),s.mesh.material=c)}}}startAnimation(){const e=()=>{this.config.enableAnimation&&(this.updateAnimation(),this.animationId=requestAnimationFrame(e))};e()}updateAnimation(){const e=this.clock.getElapsedTime();this.lightCylinders.forEach(t=>{if(t.light){const s=Math.sin(e*this.config.animationSpeed*1e3+t.animationPhase)*.3+.7;t.light.intensity=t.originalIntensity*s;const c=Math.sin(e*this.config.animationSpeed*500+t.animationPhase)*.1,h={};t.originalColor.getHSL(h),h.h=(h.h+c)%1;const p=new Z().setHSL(h.h,h.s,h.l);t.light.color.copy(p),t.mesh&&t.mesh.material&&(t.mesh.material.map||(t.mesh.material.color.copy(p),t.mesh.material.emissive&&t.mesh.material.emissive.copy(p.clone().multiplyScalar(this.config.emissiveIntensity))))}})}stopAnimation(){this.config.enableAnimation=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}setIntensity(e){this.setLightIntensity(e)}setLightIntensity(e){this.config.lightIntensity=e,this.config.intensity=e,this.lightCylinders.forEach(t=>{t.originalIntensity=e,t.light&&(t.light.intensity=e)})}toggleAnimation(){this.config.enableAnimation=!this.config.enableAnimation,this.config.enableAnimation?this.startAnimation():this.stopAnimation()}getStatus(){return{cylinderCount:this.lightCylinders.length,cubeCount:this.lightCylinders.length,lightIntensity:this.config.lightIntensity,intensity:this.config.intensity,enableAnimation:this.config.enableAnimation,enableTexture:this.config.enableTexture,radius:this.config.radius,height:this.config.height}}dispose(){this.stopAnimation(),this.lightCylinders.forEach(e=>{e.mesh&&(this.scene.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose()),e.light&&this.scene.remove(e.light)}),this.lightCylinders=[],console.log("🏛️ 发光圆柱体系统已清理")}getBestTexturePath(e){return!e||!e.startsWith("/gallery/")?e:e.split("/").pop().replace(".jpg","")}async loadGalleryTexture(e){if(!e)throw new Error("基础名称不能为空");try{console.log(`🖼️ 使用textureSystem加载Gallery纹理: ${e}`);const t=await Ae.getCompressionInfo();console.log(`🎯 当前浏览器支持格式: ${t.format} (${t.description})`);const s=await Ae.loadTexture(e);return console.log(`✅ Gallery纹理加载成功: ${e}`),s}catch(t){throw console.error(`❌ Gallery纹理加载失败: ${e}`,t),t}}}class jt{constructor(e,t,s={}){this.scene=e,this.renderer=t,this.spotlights=[],this.animationId=null,this.config={lightCount:s.lightCount||4,ceilingHeight:s.ceilingHeight||10,positions:[{x:-36,y:10,z:0},{x:36,y:10,z:0},{x:0,y:10,z:-24}],targets:[{x:-32,y:1,z:0},{x:32,y:1,z:0},{x:0,y:1,z:-20}],intensity:s.intensity||3500,distance:s.distance||70,angle:s.angle||Math.PI/2,penumbra:s.penumbra||.3,colors:[16711744,65416,65535],enableAnimation:s.enableAnimation!==!1,animationSpeed:s.animationSpeed||.5,showHelpers:s.showHelpers||!1},this.clock=new Re,this.init()}async init(){try{await this.createSpotlights(),this.config.enableAnimation&&this.startAnimation(),console.log("✨ IES聚光灯系统初始化完成")}catch(e){console.warn("⚠️ IES聚光灯初始化失败，使用标准聚光灯:",e),this.createStandardSpotlights()}}async createSpotlights(){let e=null;try{e=(await It(()=>import("./three-CWe9OjjT.js").then(s=>s.ab),__vite__mapDeps([0,1,2,3,4]))).IESSpotLight}catch(t){console.log("🎯 IESSpotLight不可用:",t.message)}e&&this.renderer.isWebGPURenderer?(console.log("🎯 使用IES聚光灯 (WebGPU)"),await this.createIESSpotlights(e)):(console.log("🎯 使用标准聚光灯（降级方案）"),this.createStandardSpotlights())}async createIESSpotlights(e){for(let t=0;t<this.config.lightCount;t++){const s=this.config.positions[t],c=this.config.targets[t],h=this.config.colors[t%this.config.colors.length],p=new e(h,this.config.intensity);if(p.position.set(s.x,s.y,s.z),p.angle=this.config.angle,p.penumbra=this.config.penumbra,p.distance=this.config.distance,p.castShadow=!0,p.shadow.mapSize.width=2048,p.shadow.mapSize.height=2048,p.shadow.camera.near=.5,p.shadow.camera.far=this.config.distance,p.shadow.bias=-1e-4,p.shadow.normalBias=.02,p.target.position.set(c.x,c.y,c.z),this.scene.add(p),this.scene.add(p.target),this.config.showHelpers){const G=new He(p);p.userData.helper=G,this.scene.add(G)}const w={light:p,originalPosition:{...s},originalTarget:{...c},originalIntensity:this.config.intensity,originalColor:new Z(h),animationPhase:t*Math.PI*.5,index:t};this.spotlights.push(w),console.log(`💡 创建IES聚光灯 ${t+1}: 位置(${s.x}, ${s.y}, ${s.z}) -> 目标(${c.x}, ${c.y}, ${c.z})`)}}createStandardSpotlights(){for(let e=0;e<this.config.lightCount;e++){const t=this.config.positions[e],s=this.config.targets[e],c=this.config.colors[e%this.config.colors.length],h=new Ge(c,this.config.intensity,this.config.distance,this.config.angle,this.config.penumbra);if(h.position.set(t.x,t.y,t.z),h.castShadow=!0,h.shadow.mapSize.width=2048,h.shadow.mapSize.height=2048,h.shadow.camera.near=.5,h.shadow.camera.far=this.config.distance,h.shadow.bias=-1e-4,h.shadow.normalBias=.02,h.target.position.set(s.x,s.y,s.z),this.scene.add(h),this.scene.add(h.target),this.config.showHelpers){const w=new He(h);h.userData.helper=w,this.scene.add(w)}const p={light:h,originalPosition:{...t},originalTarget:{...s},originalIntensity:this.config.intensity,originalColor:new Z(c),animationPhase:e*Math.PI*.5,index:e};this.spotlights.push(p),console.log(`💡 创建标准聚光灯 ${e+1}: 位置(${t.x}, ${t.y}, ${t.z}) -> 目标(${s.x}, ${s.y}, ${s.z})`)}}startAnimation(){const e=()=>{this.config.enableAnimation&&(this.updateAnimation(),this.animationId=requestAnimationFrame(e))};e()}updateAnimation(){const e=this.clock.getElapsedTime()*this.config.animationSpeed;this.spotlights.forEach((t,s)=>{const{light:c,originalTarget:h,animationPhase:p}=t,w=e+p,G=2,ee=h.x+Math.sin(w*.8)*G*.3,ge=h.z+Math.cos(w*.6)*G*.3,ce=h.y+Math.sin(w*.4)*.5;c.target.position.x=ee,c.target.position.y=ce,c.target.position.z=ge;const Ne=.9,Q=Math.sin(w*1.2+s*.5)*.2;c.intensity=t.originalIntensity*(Ne+Q);const xe=Math.sin(w*.8+s*.6)*.3,te={};t.originalColor.getHSL(te);const J=(te.h+xe+e*.1)%1,Pe=Math.max(.7,te.s+Math.sin(w*1.5)*.3),U=Math.max(.4,Math.min(.8,te.l+Math.sin(w*2)*.2)),we=new Z().setHSL(J,Pe,U);c.color.copy(we);const ie=Math.sin(w*.5+s*.3)*.02;c.angle=this.config.angle+ie,c.userData.helper&&c.userData.helper.update()})}setIntensity(e){this.config.intensity=e,this.spotlights.forEach(t=>{t.originalIntensity=e,t.light.intensity=e})}setAnimationSpeed(e){this.config.animationSpeed=e}toggleHelpers(){this.config.showHelpers=!this.config.showHelpers,this.spotlights.forEach(e=>{const{light:t}=e;if(this.config.showHelpers){if(!t.userData.helper){const s=new He(t);t.userData.helper=s,this.scene.add(s)}t.userData.helper.visible=!0}else t.userData.helper&&(t.userData.helper.visible=!1)})}toggleAnimation(){this.config.enableAnimation=!this.config.enableAnimation,this.config.enableAnimation?this.startAnimation():this.stopAnimation()}stopAnimation(){this.config.enableAnimation=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}getStatus(){return{lightCount:this.config.lightCount,intensity:this.config.intensity,enableAnimation:this.config.enableAnimation,showHelpers:this.config.showHelpers,animationSpeed:this.config.animationSpeed}}dispose(){this.stopAnimation(),this.spotlights.forEach(e=>{const{light:t}=e;t&&(this.scene.remove(t),this.scene.remove(t.target),t.userData.helper&&this.scene.remove(t.userData.helper))}),this.spotlights=[],console.log("🧹 IES聚光灯系统已清理")}}const Ct=({language:T="en"})=>{var Oe,Ue,qe,Ye,Ve,Ze,Qe;const[e,t]=z.useState(!0),[s,c]=z.useState(!1),[h,p]=z.useState(!1),[w,G]=z.useState(!1),[ee,ge]=z.useState(!1),[ce,Ne]=z.useState(!1),Q=ze(L=>L.getAllGalleryItems()),xe=ze(L=>L.texts),te=ze(L=>L.isPointerLocked),J=ze(L=>L.setIsPointerLocked),Pe=z.useRef(new Map),U=z.useRef({w:!1,a:!1,s:!1,d:!1,ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1});z.useEffect(()=>{const L=()=>{const ne=window.innerWidth<=768||"ontouchstart"in window;G(ne),ne&&ge(!0)};return L(),window.addEventListener("resize",L),()=>window.removeEventListener("resize",L)},[]);const we=z.useRef(null),ie=z.useRef(null),oe=z.useRef(null),he=z.useRef(null),C=z.useRef(null),We=z.useRef(null),ht=z.useRef(new Re),Fe=z.useRef(null),Be=z.useRef([]),_e=z.useRef(null),Ke=z.useRef([]),be=z.useRef(null),Se=z.useRef(null),je=z.useRef(null),le=z.useRef(null),dt=z.useRef(null),mt=z.useRef(null);return z.useEffect(()=>{if(!we.current)return;const L=we.current,ne=u=>{const r=new it;u.add(r),Fe.current=r;const f=32,M=72,j=new Me(f,M),d=(()=>{const y=document.createElement("canvas"),i=1024;y.width=i,y.height=i;const n=y.getContext("2d"),H="#1a1a1a",R=["#262626","#2a2a2a","#1e1e1e","#333333","#2d2d2d"];n.fillStyle=H,n.fillRect(0,0,i,i);for(let I=0;I<2e3;I++){const W=Math.random()*i,X=Math.random()*i,_=Math.random()*8+2,ae=Math.random()*.3+.1;n.globalAlpha=ae,n.fillStyle=R[Math.floor(Math.random()*R.length)],n.beginPath(),n.arc(W,X,_,0,Math.PI*2),n.fill()}n.globalAlpha=.15,n.strokeStyle="#404040",n.lineWidth=1;for(let I=0;I<50;I++){const W=Math.random()*i,X=Math.random()*i,_=Math.random()*100+50,ae=Math.random()*Math.PI*2;n.beginPath(),n.moveTo(W,X),n.lineTo(W+Math.cos(ae)*_,X+Math.sin(ae)*_),n.stroke()}const O=n.createRadialGradient(i/2,i/2,0,i/2,i/2,i/2);O.addColorStop(0,"rgba(80, 80, 80, 0.15)"),O.addColorStop(.5,"rgba(60, 60, 60, 0.08)"),O.addColorStop(1,"rgba(40, 40, 40, 0.02)"),n.globalAlpha=1,n.fillStyle=O,n.fillRect(0,0,i,i),n.globalAlpha=.06;for(let I=0;I<15;I++){const W=Math.random()*i,X=Math.random()*i,_=Math.random()*2+1;n.fillStyle="#00ffaa",n.beginPath(),n.arc(W,X,_,0,Math.PI*2),n.fill()}n.globalAlpha=1;const B=new nt(y);return B.wrapS=pe,B.wrapT=pe,B.repeat.set(6,6),B})(),K=new ye({map:d,color:1710618,metalness:.05,roughness:.3,envMapIntensity:1.2}),$=new q(j,K);$.rotation.x=-Math.PI/2,$.position.y=-2,$.receiveShadow=!0,u.add($);const se=(()=>{const y=document.createElement("canvas"),i=1024;y.width=i,y.height=i;const n=y.getContext("2d");n.fillStyle="#f8f8f8",n.fillRect(0,0,i,i);const H=64,R=2;n.strokeStyle="#e0e0e0",n.lineWidth=R;for(let B=0;B<=i;B+=H)n.beginPath(),n.moveTo(B,0),n.lineTo(B,i),n.stroke();for(let B=0;B<=i;B+=H)n.beginPath(),n.moveTo(0,B),n.lineTo(i,B),n.stroke();const O=new nt(y);return O.wrapS=pe,O.wrapT=pe,O.repeat.set(4,4),O})(),P=new q(new Me(f,M),new Le({map:se,color:16777215,transparent:!1,side:Ie}));P.rotation.x=Math.PI/2,P.position.y=8,P.receiveShadow=!0,u.add(P);const N=new Le({color:16316664,side:$e,transparent:!1}),F=32,ue=72,v=12,m=.5,g=new q(new V(F,v,m),N);g.position.set(0,3,-36),g.receiveShadow=!0,g.castShadow=!1,r.add(g),u.add(g);const a=new q(new V(10,v,m),N);a.position.set(-11,3,36),a.receiveShadow=!0,a.castShadow=!1,r.add(a),u.add(a);const b=new q(new V(10,v,m),N);b.position.set(11,3,36),b.receiveShadow=!0,b.castShadow=!1,r.add(b),u.add(b);const l=new q(new V(m,v,ue),N);l.position.set(-16,3,0),l.receiveShadow=!0,l.castShadow=!1,r.add(l),u.add(l);const x=new q(new V(m,v,ue),N);x.position.set(16,3,0),x.receiveShadow=!0,x.castShadow=!1,r.add(x),u.add(x)},E=(u,r=null)=>{if(!Q||Q.length===0){for(let v=0;v<6;v++){const m=new Me(3,2),g=new Le({color:6710886}),a=new q(m,g);v<3?(a.position.set(-6+v*6,3,-14.9),a.rotation.y=0):(a.position.set(-14.9,3,-6+(v-3)*6),a.rotation.y=Math.PI/2),u.add(a)}return}const f=Math.min(Q.length,22),M=2.2,j=4,k=async()=>{const v=[];for(let m=0;m<Math.min(Q.length,f);m++){const g=Q[m];if(g.src||g.thumbnail)try{const a=await $(g.src||g.thumbnail),b=a.width/a.height;v.push({index:m,item:g,aspectRatio:b,isPortrait:b<.8,isLandscape:b>1.3,isSquare:b>=.8&&b<=1.3})}catch{v.push({index:m,item:g,aspectRatio:1,isPortrait:!1,isLandscape:!1,isSquare:!0})}}return v},d=v=>{const m={backWall:[],rightWall:[],leftWall:[],frontWall:[]},g=v.filter(y=>y.item.position!=="lightbox"),a=g.filter(y=>y.item.wall==="vertical_wall_32m"),b=g.filter(y=>y.item.wall==="horizontal_wall_64m"),l=b.filter(y=>y.item.layer==="upper"),x=b.filter(y=>y.item.layer==="lower");return m.backWall=a.slice(0,3),m.frontWall=a.slice(3,5),m.rightWall=[...l.slice(0,4),...x.slice(0,4)],m.leftWall=[...l.slice(4,8),...x.slice(4,8)],m},K=async()=>{if(u.children.some(l=>l.name&&l.name.startsWith("painting_"))){console.log("⏭️ 跳过重复创建画作（画作已存在）");return}console.log("🎨 开始创建画廊画作...");const v=await k(),m=d(v),g=new Map,a=async(l,x,y)=>{var Ce,re,ke,fe;const i=l.item,n=l.aspectRatio;let H,R;n>1.5?(H=Math.min(j,M*n*.8),R=H/n):n<.7?(R=M,H=R*n):(R=M*.9,H=R*n);const O=new Me(H,R),B=new st({color:16777215,metalness:0,roughness:.15,clearcoat:.1,clearcoatRoughness:.1,reflectivity:.3,emissive:1052688,emissiveIntensity:.02,side:Ie}),I=new q(O,B),W=ue(I,H,R),X=35.5;switch(x){case"backWall":W.position.set(-10+y*10,2.4,-35.5),W.rotation.y=0;break;case"rightWall":{const{x:S,y:D,z:Y}=A(l.item,m.rightWall);W.position.set(S,D,Y),W.rotation.y=-Math.PI/2;break}case"leftWall":{const{x:S,y:D,z:Y}=se(l.item,m.leftWall);W.position.set(S,D,Y),W.rotation.y=Math.PI/2;break}case"frontWall":y===0?W.position.set(-10,2.4,X):W.position.set(10,2.4,X),W.rotation.y=Math.PI;break}W.castShadow=!1,W.receiveShadow=!1,W.name=`painting_${x}_${y}`,u.add(W),Ke.current.push({mesh:W,position:W.position.clone(),painting:I}),Pe.current.set(i.id,{position:W.position.clone(),item:i,mesh:W}),setTimeout(()=>{(x==="frontWall"||x==="rightWall"&&l.item.layer==="lower"||x==="leftWall"&&l.item.layer==="lower")&&P(W)},100);const _=i.src||i.thumbnail,ae=_.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,"");if(console.log(`🔍 查找纹理 - item.id: ${i.id}, 预加载纹理数量: ${((Ce=le.current)==null?void 0:Ce.textures.size)||0}`),console.log("🔍 预加载纹理keys:",Array.from(((re=le.current)==null?void 0:re.textures.keys())||[])),(ke=le.current)!=null&&ke.textures.has(i.id)){const S=le.current.textures.get(i.id);I.material.map=S,I.material.color.setHex(16777215),I.material.needsUpdate=!0,console.log(`✅ 使用预加载Gallery纹理: ${i.id}`)}else if((fe=le.current)!=null&&fe.videos.has(i.id)){const S=le.current.videos.get(i.id);if(I.material.map=S,I.material.color.setHex(16777215),I.material.needsUpdate=!0,console.log(`✅ 使用预加载视频纹理: ${i.id}`),S.image){const D=S.image;D.paused&&D.play().catch(Y=>{console.warn("Gallery视频自动播放失败，添加用户交互监听:",Y);const Ee=()=>{D.paused&&D.play().then(()=>{console.log(`🎬 Gallery视频用户交互后开始播放: ${i.id}`)}).catch(gt=>console.warn("用户交互后播放失败:",gt))};document.addEventListener("click",Ee,{once:!0}),document.addEventListener("touchstart",Ee,{once:!0})})}}else if(g.has(_))I.material.map=g.get(_),I.material.color.setHex(16777215),I.material.needsUpdate=!0;else try{if(i.type==="video"){const S=document.createElement("video");S.src=_,S.autoplay=i.autoplay||!0,S.loop=i.loop||!0,S.muted=i.muted||!0,S.controls=i.controls||!1,S.crossOrigin="anonymous",S.playsInline=!0,await new Promise((Y,Ee)=>{S.oncanplay=Y,S.onerror=Ee,S.load()});const D=new Lt(S);D.generateMipmaps=!1,D.minFilter=ot,D.magFilter=ot,D.flipY=!0,D.colorSpace=tt,g.set(_,D),I.material.map=D,I.material.color.setHex(16777215),I.material.needsUpdate=!0,S.play().catch(Y=>{console.warn("视频自动播放失败，需要用户交互:",Y)}),console.log(`🎬 加载视频纹理: ${i.title.zh||i.title.en}`)}else{let S;i.id==="gallery_lightbox"?S=i.src.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,""):S=i.id.replace(/_/g,"-"),console.log(`⚠️ 预加载纹理不可用，尝试单独加载: ${i.id} -> ${S}`);const D=await Ae.loadSceneTextures("gallery",{images:[S],folder:"gallery"});if(D.textures.has(S)){const Y=D.textures.get(S);g.set(_,Y),I.material.map=Y,I.material.color.setHex(16777215),I.material.needsUpdate=!0,console.log(`✅ 单独加载Gallery纹理成功: ${S}`)}else throw new Error(`纹理加载失败: ${S}`)}}catch(S){console.warn(`Gallery纹理加载失败: ${ae}`,S),I.material.color.setHex(6710886),I.material.needsUpdate=!0}},b=[...m.backWall.map((l,x)=>({data:l,wallType:"backWall",index:x})),...m.rightWall.map((l,x)=>({data:l,wallType:"rightWall",index:x})),...m.leftWall.map((l,x)=>({data:l,wallType:"leftWall",index:x})),...m.frontWall.map((l,x)=>({data:l,wallType:"frontWall",index:x}))];for(let l=0;l<b.length;l+=4){const x=b.slice(l,l+4);await Promise.all(x.map(({data:y,wallType:i,index:n})=>a(y,i,n))),l+4<b.length&&await new Promise(y=>setTimeout(y,100))}console.log("🎨 所有画作纹理加载完成，触发加载管理器回调"),r&&r.onLoad&&setTimeout(()=>{r.onLoad()},200)},$=v=>new Promise(m=>{const g=new Image;g.onload=()=>{m({width:g.width,height:g.height})},g.onerror=()=>{m({width:300,height:200})},g.src=v}),A=(v,m)=>{const x=[-28,-12,4,20],y=[-20,-4,12,28];if(v.layer==="upper"){const i=m.filter(n=>n.item.layer==="upper").findIndex(n=>n.item.id===v.id);return{x:15.5,y:1.8+1.2,z:y[i]||0}}else{const i=m.filter(n=>n.item.layer==="lower").findIndex(n=>n.item.id===v.id);return{x:15.5,y:1.8,z:x[i]||0}}},se=(v,m)=>{const a=A(v,m);return{x:-15.5,y:a.y,z:-a.z}},P=v=>{const m=v.position,g=v.rotation,a=Math.abs(g.y)<.1||Math.abs(g.y-Math.PI)<.1;let b,l,x,y;a?(b=Math.PI/9,l=.08,x=12,y=6):(b=Math.PI/6,l=.15,x=15,y=3.5);const i=new Ge(16775393,1.5,x,b,l,1);let n=new at;const H=Math.max(7,m.y+y),R=1.8;return Math.abs(g.y)<.1?n.set(m.x,H,m.z+R):Math.abs(g.y-Math.PI)<.1?n.set(m.x,H,m.z-R):Math.abs(g.y+Math.PI/2)<.1?n.set(m.x-R,H,m.z):Math.abs(g.y-Math.PI/2)<.1&&n.set(m.x+R,H,m.z),i.position.copy(n),i.target=v,i.castShadow=!1,i.userData={paintingPosition:m.clone(),baseIntensity:1,maxIntensity:8,activationDistance:6,optimalDistance:2},u.add(i),u.add(i.target),Be.current.push(i),i},N=.05,F=.1,ue=(v,m=2.5,g=2)=>{const a=new it,b=new st({color:1710618,metalness:.8,roughness:.2,clearcoat:.3,clearcoatRoughness:.1,emissive:657930,emissiveIntensity:.05}),l=[new V(m+F*2,F,N),new V(m+F*2,F,N),new V(F,g,N),new V(F,g,N)],x=[{x:0,y:(g+F)/2,z:N/2},{x:0,y:-(g+F)/2,z:N/2},{x:-(m+F)/2,y:0,z:N/2},{x:(m+F)/2,y:0,z:N/2}];return l.forEach((y,i)=>{const n=new q(y,b);n.position.set(x[i].x,x[i].y,x[i].z),n.castShadow=!1,n.receiveShadow=!1,a.add(n)}),a.add(v),a};K()},de=(u,r)=>{const f=6*u,M=he.current,j=M.position.clone();(U.current.w||U.current.ArrowUp)&&r.moveForward(f),(U.current.s||U.current.ArrowDown)&&r.moveForward(-f),(U.current.d||U.current.ArrowRight)&&r.moveRight(f),(U.current.a||U.current.ArrowLeft)&&r.moveRight(-f),me(M)&&M.position.copy(j),((d,K)=>{if(!K.isLocked)return;let $=null,A=1/0;const se=4;if(Pe.current.forEach(P=>{const N=d.position.distanceTo(P.position);N<se&&N<A&&(A=N,$=P)}),$){const P=$.position.y,N=d.position.y,F=P-N;d.position.y+=F*.15}else{const F=2.4-d.position.y;d.position.y+=F*.08}d.position.y=Math.max(1.2,Math.min(3.5,d.position.y))})(M,r),r.isLocked||(M.position.y=2.4),ve(M.position)},me=u=>{const r=u.position,f=14.5,M=34.5;if(r.x>f||r.x<-f||r.z>M||r.z<-M)return!0;const j=[{x:-32/3,z:24,radius:.5},{x:32/3,z:24,radius:.5},{x:0,z:-18,radius:1.618/2}],k=.5;for(const d of j)if(Math.sqrt(Math.pow(r.x-d.x,2)+Math.pow(r.z-d.z,2))<d.radius+k)return!0;return!1},ve=u=>{Be.current.forEach(r=>{const f=r.userData;if(!f||!f.paintingPosition)return;const M=u.distanceTo(f.paintingPosition);let j=f.baseIntensity;if(M<=f.activationDistance){const k=Math.max(0,(f.activationDistance-M)/f.activationDistance),d=f.maxIntensity-f.baseIntensity,K=Math.pow(k,1.5);j=f.baseIntensity+d*K,M<=f.optimalDistance&&(j=f.maxIntensity)}r.intensity=De.lerp(r.intensity,j,.12)}),Je(u)},Je=u=>{const r=_e.current;if(!r)return;let f=1/0;Ke.current.forEach(j=>{const k=u.distanceTo(j.position);k<f&&(f=k)});const M=he.current;if(M){const j=new at;M.getWorldDirection(j);const k=M.position.clone().add(j.multiplyScalar(10));r.target.position.copy(k),r.target.updateMatrixWorld()}if(f<=6){const k=3+Math.max(0,(6-f)/6)*12;r.intensity=De.lerp(r.intensity,k,.1)}else r.intensity=De.lerp(r.intensity,1.5,.1)},Xe=()=>{const u=he.current;if(!u)return;const r={phase1:{duration:2500,startPos:{x:0,y:2.4,z:15},endPos:{x:0,y:2.4,z:12},startLookAt:{x:0,y:8,z:0},endLookAt:{x:0,y:8,z:0}},phase2:{duration:3e3,startPos:{x:0,y:2.4,z:12},endPos:{x:0,y:2.4,z:5},startLookAt:{x:0,y:8,z:0},endLookAt:{x:0,y:4,z:0}},phase3:{duration:2e3,startPos:{x:0,y:2.4,z:5},endPos:{x:0,y:2.4,z:0},startLookAt:{x:0,y:4,z:0},endLookAt:{x:0,y:2.4,z:-1}}};u.position.set(r.phase1.startPos.x,r.phase1.startPos.y,r.phase1.startPos.z),u.lookAt(r.phase1.startLookAt.x,r.phase1.startLookAt.y,r.phase1.startLookAt.z);let f=1,M=Date.now();const j=d=>{const K=Date.now()-M,$=Math.min(K/d.duration,1),A=$<.5?4*$*$*$:1-Math.pow(-2*$+2,3)/2;u.position.x=d.startPos.x+(d.endPos.x-d.startPos.x)*A,u.position.y=d.startPos.y+(d.endPos.y-d.startPos.y)*A,u.position.z=d.startPos.z+(d.endPos.z-d.startPos.z)*A;const se={x:d.startLookAt.x+(d.endLookAt.x-d.startLookAt.x)*A,y:d.startLookAt.y+(d.endLookAt.y-d.startLookAt.y)*A,z:d.startLookAt.z+(d.endLookAt.z-d.startLookAt.z)*A};return u.lookAt(se.x,se.y,se.z),$>=1},k=()=>{let d=!1;switch(f){case 1:d=j(r.phase1),d&&(f=2,M=Date.now());break;case 2:d=j(r.phase2),d&&(f=3,M=Date.now());break;case 3:if(d=j(r.phase3),d){c(!0),t(!1),setTimeout(()=>{p(!0)},9e3),C.current&&(C.current.getObject().position.copy(u.position),C.current.connect=C.current.connect.__original||C.current.connect);return}break}dt.current=requestAnimationFrame(k)};k()};return(async()=>{try{if(ie.current||oe.current)return;const u=new xt;mt.current=u;let r=!1;const f=async()=>{try{const a=[],b=[];Q.slice(0,12).forEach(i=>{let n;i.id==="gallery_lightbox"?n=i.src.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,""):n=i.id.replace(/_/g,"-"),i.type==="video"?b.push({id:i.id,fileName:n,src:i.src}):a.push({id:i.id,fileName:n})}),console.log("🎨 开始预加载Gallery纹理...",{images:a.length,videos:b.length});const l=await Ae.loadSceneTextures("gallery",{images:a.map(i=>i.fileName),videos:b.map(i=>({name:i.fileName,src:i.src})),folder:"gallery",onProgress:(i,n,H)=>{console.log(`📦 Gallery纹理加载进度: ${n}/${H} (${Math.round(i*100)}%)`)}}),x=new Map,y=new Map;a.forEach(({id:i,fileName:n})=>{l.textures.has(n)&&x.set(i,l.textures.get(n))}),b.forEach(({id:i,fileName:n})=>{l.videos.has(n)&&y.set(i,l.videos.get(n))}),le.current={textures:x,videos:y,errors:l.errors},console.log(`✅ Gallery纹理预加载完成: ${l.textures.size}张图片, ${l.videos.size}个视频`),l.errors.length>0&&console.warn("⚠️ 部分Gallery纹理加载失败:",l.errors),r=!0,M&&r&&j()}catch(a){console.warn("Gallery纹理预加载失败，使用fallback:",a),le.current={textures:new Map,videos:new Map,errors:[]},r=!0,M&&j()}};let M=!1;const j=()=>{requestAnimationFrame(()=>{oe.current&&ie.current&&he.current?(oe.current.render(ie.current,he.current),requestAnimationFrame(()=>{setTimeout(()=>{Xe()},300)})):setTimeout(()=>{Xe()},500)})};u.onLoad=()=>{console.log("🎭 THREE.js场景加载完成"),M=!0,r&&j()},u.onError=()=>{},f();const k=new wt;k.background=new Z(1710618),ie.current=k;const d=new bt(75,L.clientWidth/L.clientHeight,.1,1e3);d.position.set(0,2.4,0),he.current=d;const K=new Ge(16774374,6,15,Math.PI/5,.15,1.2);K.position.set(0,0,0),K.castShadow=!1;const $=new St;K.target=$,d.add(K),k.add($),k.add(d),_e.current=K;const A=new vt({antialias:!0,alpha:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1});if(A.setSize(L.clientWidth,L.clientHeight),A.setClearColor(15790320,1),A.shadowMap.enabled=!0,A.shadowMap.type=kt,A.outputColorSpace=tt,A.toneMapping=Mt,A.toneMappingExposure=1,!A.getContext())throw new Error("WebGL context creation failed");L.appendChild(A.domElement),oe.current=A;let P;try{document&&document.body&&document.documentElement&&window.self===window.top&&"requestPointerLock"in document.body?P=new Te(d,document.body):(P=new Te(d,A.domElement),console.warn("Pointer Lock API not available, using fallback mode"))}catch(a){console.warn("PointerLockControls initialization failed:",a),P=new Te(d,A.domElement)}k.add(P.getObject()),C.current=P;try{P.addEventListener("lock",()=>{J(!0)}),P.addEventListener("unlock",()=>{J(!1)})}catch(a){console.warn("PointerLockControls event setup failed:",a)}try{const a=P.connect;a&&(P.connect.__original=a,P.connect=()=>{if(s)try{a.call(P)}catch(b){console.warn("PointerLockControls connect failed:",b)}})}catch(a){console.warn("PointerLockControls connect override failed:",a)}const N=a=>{const l=(()=>{const n=new V(12,12,.4),H=new ye({color:16777215,emissive:0,emissiveIntensity:0}),R=new q(n,H);R.position.set(0,3,35.8),a.add(R);const B=(()=>{const X=new Me(11,9),_=Q.find(fe=>fe.position==="lightbox"),ae=_?_.src||_.thumbnail:"/gallery/gallery-vertical-0.jpg",Ce=new Le({color:4474111,emissive:0,emissiveIntensity:0,transparent:!0,opacity:.61,side:$e}),re=new q(X,Ce);re.position.set(0,3,36-.4-.02),re.rotation.y=Math.PI,re.name="LightboxGallery",a.add(re);const ke=ae.split("/").pop().replace(/\.(jpg|jpeg|png|webp|avif)$/i,"");return console.log(`💡 Lightbox纹理加载: ${ae} -> ${ke}`),Ae.loadTexture(ke).then(fe=>{const S=new Le({map:fe,emissive:0,emissiveIntensity:0,transparent:!0,opacity:.61,side:$e});re.material=S}).catch(()=>{console.warn("Failed to load lightbox texture, keeping placeholder")}),re})();return{lightBox:R,lightboxDisplay:B}})();return{wallLightBox:l.lightBox,lightboxDisplay:l.lightboxDisplay}},F=()=>{const a=[];return[{start:{x:-3,z:2.25},end:{x:3,z:2.25},name:"王-上横"},{start:{x:-2.5,z:0},end:{x:2.5,z:0},name:"王-中横"},{start:{x:-3.5,z:-2.25},end:{x:3.5,z:-2.25},name:"王-下横"},{start:{x:0,z:2.25},end:{x:0,z:-2.25},name:"王-竖线"}].forEach(l=>{const x=Math.sqrt(Math.pow(l.end.x-l.start.x,2)+Math.pow(l.end.z-l.start.z,2));let y;l.name.includes("竖")?y=new V(.4,.2,x):y=new V(x,.2,.4);const i=new ye({color:16777215,emissive:16777215,emissiveIntensity:2,transparent:!1}),n=new q(y,i),H=(l.start.x+l.end.x)/2,R=(l.start.z+l.end.z)/2;n.position.set(H,6,R),k.add(n);const O=new lt(16777215,7,45);O.position.set(H,5.5,R),k.add(O),a.push({tube:n,name:l.name})}),a};N(k),F(),ne(k),E(k,u);const ue=()=>{try{const a={intensity:4,colors:[16739179,5164484,4569041,16370212],showHelpers:!1,enableAnimation:!0,animationSpeed:8e-4,lightWidth:8,lightHeight:6,positions:[{x:-30,y:10,z:0,rx:0,ry:Math.PI/2,rz:0},{x:30,y:10,z:0,rx:0,ry:-Math.PI/2,rz:0},{x:0,y:11.5,z:30,rx:-Math.PI/3,ry:0,rz:0},{x:0,y:11.5,z:-10,rx:-Math.PI/3,ry:Math.PI,rz:0}]};be.current=new Pt(k,a),be.current.setPreset("soft"),console.log("RectAreaLighting系统初始化成功")}catch(a){console.warn("RectAreaLighting初始化失败:",a)}},v=async()=>{try{const a={cubeSize:2.5,cubeCount:3,spacing:10,height:6,intensity:2.5,lightSize:2,enableAnimation:!0,animationSpeed:.001,showCubeMesh:!0,cubeOpacity:.05,showHelpers:!1};Se.current=new Wt(k,a,Q),await Se.current.init(),console.log("光柱系统初始化成功")}catch(a){console.warn("光柱系统初始化失败:",a)}},m=()=>{try{const a={lightCount:3,intensity:4200,distance:80,angle:Math.PI/1.8,penumbra:.4,enableAnimation:!0,animationSpeed:.3,showHelpers:!1};je.current=new jt(k,A,a),console.log("✨ 3灯位IES聚光灯系统初始化成功 - 避开lightbox墙面")}catch(a){console.warn("⚠️ IES聚光灯系统初始化失败:",a)}};setTimeout(()=>{ue(),setTimeout(async()=>{await v(),setTimeout(()=>{m()},200)},100)},300);const g=()=>{We.current=requestAnimationFrame(g);const a=ht.current.getDelta();P.isLocked&&de(a,P),k.traverse(b=>{b.material&&b.material.map&&b.material.map.isVideoTexture&&(b.material.map.needsUpdate=!0)}),A.render(k,d)};g(),t(!1)}catch(u){throw t(!1),u}})().catch(u=>{console.error("Gallery场景初始化失败:",u),t(!1)}),()=>{var u;(u=C.current)!=null&&u.isLocked&&(console.log("🔓 Gallery组件卸载时强制解锁指针"),C.current.unlock()),J(!1),be.current&&(be.current.dispose(),be.current=null,console.log(" 🧹 RectAreaLighting系统已清理")),Se.current&&(Se.current.dispose(),Se.current=null,console.log(" 🏛️ 发光圆柱体系统已清理")),je.current&&(je.current.dispose(),je.current=null,console.log(" 🧹 IES聚光灯系统已清理")),We.current&&(cancelAnimationFrame(We.current),We.current=null),C.current&&(C.current.isLocked&&C.current.unlock(),C.current.dispose(),C.current=null,console.log(" 🎮 Gallery控制器已清理")),ie.current&&(ie.current.traverse(r=>{r.geometry&&r.geometry.dispose(),r.material&&(Array.isArray(r.material)?r.material.forEach(f=>{f.map&&f.map.dispose(),f.normalMap&&f.normalMap.dispose(),f.roughnessMap&&f.roughnessMap.dispose(),f.dispose()}):(r.material.map&&r.material.map.dispose(),r.material.normalMap&&r.material.normalMap.dispose(),r.material.roughnessMap&&r.material.roughnessMap.dispose(),r.material.dispose()))}),ie.current.clear(),ie.current=null),oe.current&&(L&&L.contains(oe.current.domElement)&&L.removeChild(oe.current.domElement),oe.current.dispose(),oe.current=null),he.current=null,Fe.current=null,console.log("🧹 Gallery 组件清理完成")}},[Q,s,J]),z.useEffect(()=>{const L=()=>{var E;!(document.pointerLockElement!==null)&&((E=C.current)!=null&&E.isLocked)&&(console.log("🔓 检测到指针锁定状态不一致，强制同步状态"),C.current&&(C.current.disconnect(),setTimeout(()=>{C.current&&C.current.connect()},100)),J(!1))};return document.addEventListener("pointerlockchange",L),document.addEventListener("pointerlockerror",L),()=>{document.removeEventListener("pointerlockchange",L),document.removeEventListener("pointerlockerror",L)}},[J]),z.useEffect(()=>{const L=E=>{var me,ve;if((me=C.current)!=null&&me.isLocked&&!["KeyW","KeyA","KeyS","KeyD","Escape"].includes(E.code)&&E.key!=="Escape"){E.preventDefault(),E.stopPropagation(),console.log("🔒 画廊导航模式：只允许WASD移动和ESC退出");return}const de=E.code==="KeyW"?"w":E.code==="KeyA"?"a":E.code==="KeyS"?"s":E.code==="KeyD"?"d":E.key.toLowerCase();de in U.current&&(U.current[de]=!0),E.key==="Escape"&&((ve=C.current)!=null&&ve.isLocked)&&(console.log("🔓 ESC键解锁指针"),C.current.unlock())},ne=E=>{var me;if((me=C.current)!=null&&me.isLocked&&!["KeyW","KeyA","KeyS","KeyD"].includes(E.code)){E.preventDefault(),E.stopPropagation();return}const de=E.code==="KeyW"?"w":E.code==="KeyA"?"a":E.code==="KeyS"?"s":E.code==="KeyD"?"d":E.key;de in U.current&&(U.current[de]=!1)};return document.addEventListener("keydown",L),document.addEventListener("keyup",ne),()=>{document.removeEventListener("keydown",L),document.removeEventListener("keyup",ne)}},[]),o.jsxs(o.Fragment,{children:[w&&ee&&o.jsx("div",{className:"fixed inset-0 z-[99999] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4",children:o.jsxs("div",{className:"bg-white/10 backdrop-blur-md rounded-2xl p-8 text-center max-w-md border border-white/20",children:[o.jsxs("div",{className:"mb-6",children:[o.jsx("svg",{className:"w-16 h-16 text-yellow-400 mx-auto mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"})}),o.jsx("h3",{className:"text-2xl font-bold text-white mb-2",children:T==="zh"?"移动端体验提示":"Mobile Experience Notice"}),o.jsx("p",{className:"text-white/80 leading-relaxed",children:T==="zh"?"3D 画廊采用第一人称漫游技术，需要键盘和鼠标操作，移动端体验可能不佳。建议使用桌面设备以获得最佳浏览效果。":"The 3D gallery uses first-person navigation technology requiring keyboard and mouse controls. For the best experience, Hua recommend using a desktop device."})]}),o.jsxs("div",{className:"space-y-3",children:[o.jsx("button",{onClick:()=>{ge(!1),Ne(!0)},className:"w-full bg-theme-primary/20 hover:bg-theme-primary/30 text-theme-primary border border-theme-primary/30 hover:border-theme-primary/50 py-3 px-6 rounded-lg transition-all duration-300",children:T==="zh"?"继续浏览图片集":"View Image Gallery"}),o.jsx("p",{className:"text-white/60 text-sm",children:T==="zh"?"或在桌面设备上体验完整的 3D 画廊":"Or visit on desktop for the full 3D gallery experience"})]})]})}),w&&ce&&o.jsx(ct,{language:T,texts:xe}),!w&&o.jsxs("section",{id:"gallery",className:"min-h-screen flex flex-col justify-center items-center bg-gray-100 relative overflow-hidden",children:[(e||!s)&&o.jsx(At,{size:160,strokeWidth:12,showMask:!0,maskColor:"black-solid"}),o.jsx("div",{ref:we,className:`w-full h-screen relative bg-gray-200 ${e||!s?"invisible":"visible"}`,style:{minHeight:"100vh"}}),o.jsxs("div",{className:`absolute bottom-6 left-6 bg-black/50 backdrop-blur-md rounded-xl p-4 text-white z-20 max-w-sm transition-all duration-1000 ${!e&&s&&h&&!te?"opacity-100 translate-y-0":"opacity-0 translate-y-4 pointer-events-none"}`,children:[o.jsx("p",{className:"text-lg font-medium mb-3",children:T==="zh"?"如何操作？":"How to Play?"}),o.jsxs("div",{className:"space-y-3 text-sm",children:[o.jsxs("p",{className:"flex items-center",children:[o.jsx("span",{className:"w-2"}),T==="zh"?"点击进入长廊":"Click to enter the gallery"]}),o.jsxs("p",{className:"flex items-center",children:[o.jsx("span",{className:"w-2"}),T==="zh"?"鼠标 - 环视周围，探索画作":"Mouse - Look around and explore"]}),o.jsxs("p",{className:"flex items-center",children:[o.jsx("span",{className:"w-2"}),o.jsxs("span",{className:"inline-flex items-center gap-1 mr-2",children:[o.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono border border-white/30",children:"W"}),o.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono border border-white/30",children:"A"}),o.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono border border-white/30",children:"S"}),o.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono border border-white/30",children:"D"})]}),o.jsx("span",{children:T==="zh"?"移动穿行长廊":"Move through the gallery"})]}),o.jsxs("p",{className:"flex items-center",children:[o.jsx("span",{className:"w-2"}),o.jsx("span",{className:"inline-flex items-center px-2 py-0.5 mr-2 bg-white/20 rounded text-xs font-mono border border-white/30",children:"ESC"}),o.jsx("span",{children:T==="zh"?"退出指针锁定模式":"Exit pointer lock mode"})]})]})]}),o.jsx("div",{className:`absolute inset-0 flex items-center justify-center cursor-pointer z-10 transition-all duration-1000 ${!e&&s&&h&&!te?"opacity-100 scale-100":"opacity-0 scale-95 pointer-events-none"}`,onClick:()=>{var L;if(!e&&s&&h&&!te)if((L=C.current)!=null&&L.lock)try{C.current.lock(),setTimeout(()=>{te||(console.log("Fallback: manually setting pointer locked state"),J(!0))},100)}catch(ne){console.log("Pointer lock failed, using fallback:",ne.message),J(!0)}else J(!0)},children:o.jsxs("div",{className:"bg-white/10 backdrop-blur-md rounded-2xl p-8 text-center transition-all duration-300 border border-white/20 hover:bg-white/20 hover:scale-105",children:[o.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:((qe=(Ue=(Oe=xe[T])==null?void 0:Oe.gallery)==null?void 0:Ue.gallery3D)==null?void 0:qe.title)||"浮生长廊"}),o.jsx("p",{className:"text-white/80 mb-6",children:((Qe=(Ze=(Ve=(Ye=xe[T])==null?void 0:Ye.gallery)==null?void 0:Ve.gallery3D)==null?void 0:Ze.instructions)==null?void 0:Qe.clickToStart)||"点击进入"}),o.jsx("div",{className:"animate-bounce",children:o.jsxs("svg",{className:"w-8 h-8 text-white mx-auto",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})]})}),te&&o.jsx(o.Fragment,{children:o.jsxs("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-20",children:[o.jsx("div",{className:"w-2 h-2 bg-white rounded-full shadow-lg border border-white/30"}),o.jsx("div",{className:"absolute w-6 h-0.5 bg-white/60 rounded shadow-sm"}),o.jsx("div",{className:"absolute w-0.5 h-6 bg-white/60 rounded shadow-sm"}),o.jsx("div",{className:"absolute w-8 h-8 border border-white/20 rounded-full"})]})})]})]})};Ct.propTypes={language:rt.string};export{Ct as default};
