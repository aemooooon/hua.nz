<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Style Lorenz Attractor Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            z-index: 100;
            font-size: 14px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div id="info">
        Galaxy Style Lorenz Attractor Test<br>
        âœ¨ Orange glowing core with blue particle trail<br>
        ğŸŒŸ Galaxy-style gradient particles<br>
        ğŸ’« Additive blending for bloom effect
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r158/three.min.js"></script>
    <script>
        // ç®€åŒ–ç‰ˆæœ¬ï¼Œä¸ä½¿ç”¨æ¨¡å—å¯¼å…¥
        console.log('Starting Galaxy Lorenz Test...');
        console.log('THREE version:', THREE.REVISION);

        class GalaxyLorenzAttractor {
            constructor() {
                this.canvas = null;
                this.renderer = null;
                this.scene = null;
                this.camera = null;
                this.fireball = null;
                this.halo = null;
                this.trailPositions = [];
                this.animationFrameId = null;
                this.time = 0;

                // Lorenz å‚æ•°
                this.sigma = 10;
                this.rho = 28;
                this.beta = 8 / 3;
                this.x = 0.1;
                this.y = 0;
                this.z = 0;
                this.dt = 0.01;
                this.maxParticles = 2000;

                // Galaxy é¢œè‰²
                this.colorInside = new THREE.Color('#ffa575'); // æ©™è‰²å†…æ ¸
                this.colorOutside = new THREE.Color('#0088ff'); // è“è‰²å¤–å›´

                this.init();
                this.animate();
            }

            init() {
                // Scene setup
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000a15);

                // Camera
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 0, 60);
                this.camera.lookAt(0, 0, 0);

                // Renderer
                this.canvas = document.createElement('canvas');
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: this.canvas, 
                    antialias: true,
                    alpha: false,
                    powerPreference: "high-performance"
                });
                
                // ç®€åŒ–ç‰ˆæœ¬ - ä¸ä½¿ç”¨åå¤„ç†ï¼Œç›´æ¥æ¸²æŸ“
                this.renderer.setSize(window.innerWidth, window.innerHeight, false);
                this.renderer.setClearColor(0x000a15, 1.0);
                document.body.appendChild(this.canvas);
                
                // æš‚æ—¶æ³¨é‡Šæ‰åå¤„ç†ç®¡é“ï¼Œå…ˆç¡®ä¿åŸºç¡€æ¸²æŸ“å·¥ä½œ
                /*
                this.composer = new EffectComposer(this.renderer);
                
                const renderPass = new RenderPass(this.scene, this.camera);
                this.composer.addPass(renderPass);
                
                const bloomPass = new UnrealBloomPass(
                    new THREE.Vector2(window.innerWidth, window.innerHeight),
                    1.8,
                    0.6,
                    0.8
                );
                this.composer.addPass(bloomPass);
                
                const outputPass = new OutputPass();
                this.composer.addPass(outputPass);
                */

                // Galaxy é£æ ¼å‘å…‰ä¸»çƒ
                const fireballGeometry = new THREE.SphereGeometry(2.0, 32, 32);
                const fireballMaterial = new THREE.MeshBasicMaterial({
                    color: this.colorInside,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending,
                });

                this.fireball = new THREE.Mesh(fireballGeometry, fireballMaterial);
                this.scene.add(this.fireball);
                
                // å‘å…‰å…‰ç¯
                const haloGeometry = new THREE.SphereGeometry(3.5, 32, 32);
                const haloMaterial = new THREE.MeshBasicMaterial({
                    color: new THREE.Color('#ff8844'),
                    transparent: true,
                    opacity: 0.3,
                    blending: THREE.AdditiveBlending,
                    side: THREE.BackSide,
                });
                
                this.halo = new THREE.Mesh(haloGeometry, haloMaterial);
                this.scene.add(this.halo);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
                this.scene.add(ambientLight);
                
                const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.0);
                directionalLight1.position.set(50, 50, 50);
                this.scene.add(directionalLight1);
                
                const directionalLight2 = new THREE.DirectionalLight(0x6699ff, 0.8);
                directionalLight2.position.set(-50, -50, 50);
                this.scene.add(directionalLight2);
                
                this.pointLight = new THREE.PointLight(0xffa575, 2.0, 100);
                this.scene.add(this.pointLight);

                // ç®€åŒ–ç²’å­ç³»ç»Ÿ - ä½¿ç”¨åŸºç¡€å‡ ä½•ä½“
                this.createParticleTexture();
                
                this.particleGeometry = new THREE.SphereGeometry(0.5, 8, 8);
                this.particleMaterial = new THREE.MeshBasicMaterial({
                    color: 0x0088ff,
                    transparent: true,
                    opacity: 0.8,
                });
                
                this.instancedMesh = new THREE.InstancedMesh(
                    this.particleGeometry, 
                    this.particleMaterial, 
                    this.maxParticles
                );
                
                this.scene.add(this.instancedMesh);
                
                console.log('Particle system created');
                
                // åˆå§‹åŒ–å®ä¾‹
                const matrix = new THREE.Matrix4();
                const position = new THREE.Vector3();
                const scale = new THREE.Vector3(0, 0, 0);
                
                for (let i = 0; i < this.maxParticles; i++) {
                    matrix.compose(position, new THREE.Quaternion(), scale);
                    this.instancedMesh.setMatrixAt(i, matrix);
                }
                this.instancedMesh.instanceMatrix.needsUpdate = true;

                console.log('Initialization complete');

                window.addEventListener('resize', this.onResize.bind(this));
            }

            createParticleTexture() {
                const size = 32;
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                
                const context = canvas.getContext('2d');
                const center = size / 2;
                
                const gradient = context.createRadialGradient(center, center, 0, center, center, center);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
                gradient.addColorStop(0.2, 'rgba(255, 255, 255, 0.8)');
                gradient.addColorStop(0.4, 'rgba(255, 255, 255, 0.4)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                context.fillStyle = gradient;
                context.fillRect(0, 0, size, size);
                
                this.particleTexture = new THREE.CanvasTexture(canvas);
            }

            animate() {
                this.animationFrameId = requestAnimationFrame(this.animate.bind(this));

                this.time += 0.016;

                // Lorenz equations
                const dx = this.sigma * (this.y - this.x) * this.dt;
                const dy = (this.x * (this.rho - this.z) - this.y) * this.dt;
                const dz = (this.x * this.y - this.beta * this.z) * this.dt;
                
                this.x += dx;
                this.y += dy;
                this.z += dz;

                // Update main ball position
                const scale = 0.8;
                this.fireball.position.set(this.x * scale, this.y * scale, this.z * scale);
                
                // Halo animation
                this.halo.position.copy(this.fireball.position);
                this.halo.scale.setScalar(1.0 + Math.sin(this.time * 2) * 0.1);
                
                this.pointLight.position.copy(this.fireball.position);

                // Add trail positions
                this.trailPositions.push({
                    x: this.x * scale,
                    y: this.y * scale,
                    z: this.z * scale,
                    life: 1.0
                });

                if (this.trailPositions.length > this.maxParticles) {
                    this.trailPositions.shift();
                }

                // ç®€åŒ–ç²’å­æ›´æ–°
                const matrix = new THREE.Matrix4();
                const position = new THREE.Vector3();
                const quaternion = new THREE.Quaternion();
                const scale_vec = new THREE.Vector3();

                this.trailPositions.forEach((pos, index) => {
                    const fadeRate = (index / this.trailPositions.length);
                    const particleScale = fadeRate * 0.8 + 0.2;
                    
                    position.set(
                        pos.x + (Math.random() - 0.5) * 0.08,
                        pos.y + (Math.random() - 0.5) * 0.08,
                        pos.z + (Math.random() - 0.5) * 0.08
                    );
                    scale_vec.set(particleScale, particleScale, particleScale);
                    
                    matrix.compose(position, quaternion, scale_vec);
                    this.instancedMesh.setMatrixAt(index, matrix);
                });

                // Hide unused instances
                for (let i = this.trailPositions.length; i < this.maxParticles; i++) {
                    scale_vec.set(0, 0, 0);
                    matrix.compose(position, quaternion, scale_vec);
                    this.instancedMesh.setMatrixAt(i, matrix);
                }

                this.instancedMesh.instanceMatrix.needsUpdate = true;

                // Gentle scene rotation
                this.scene.rotation.y += 0.005;
                this.scene.rotation.x += 0.002;

                // ä½¿ç”¨æ ‡å‡†æ¸²æŸ“ï¼Œä¸ç”¨åå¤„ç†
                this.renderer.render(this.scene, this.camera);
                // this.composer.render();
            }

            onResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight, false);
                // if (this.composer) {
                //     this.composer.setSize(window.innerWidth, window.innerHeight);
                // }
            }
        }

        // Start the effect
        try {
            console.log('Starting Galaxy Lorenz Attractor...');
            new GalaxyLorenzAttractor();
        } catch (error) {
            console.error('Error starting effect:', error);
            document.body.innerHTML = '<div style="color: white; padding: 20px;">Error: ' + error.message + '</div>';
        }
    </script>
</body>
</html>
