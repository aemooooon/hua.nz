<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modified EffectLorenzAttractor</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            z-index: 100;
            font-size: 14px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="info">
        Testing Modified EffectLorenzAttractor<br>
        Status: <span id="status">Loading...</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r158/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r158/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r158/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r158/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r158/examples/js/postprocessing/OutputPass.js"></script>
    <script>
        document.getElementById('status').textContent = 'THREE.js loaded, starting test...';
        
        // 模拟修改后的 EffectLorenzAttractor 逻辑
        class TestLorenzAttractor {
            constructor() {
                console.log('Creating TestLorenzAttractor...');
                
                this.canvas = document.createElement('canvas');
                this.renderer = null;
                this.scene = null;
                this.camera = null;
                this.fireball = null;
                this.halo = null;
                this.trailPositions = [];
                this.animationFrameId = null;
                this.time = 0;

                // Lorenz 参数
                this.sigma = 10;
                this.rho = 28;
                this.beta = 8 / 3;
                this.x = 0.1;
                this.y = 0;
                this.z = 0;
                this.dt = 0.01;
                this.maxParticles = 2000;

                // Galaxy 颜色
                this.colorInside = new THREE.Color('#ffa575');
                this.colorOutside = new THREE.Color('#0088ff');

                this.init();
                this.start();
                
                document.getElementById('status').textContent = 'Initialized and started';
            }

            init() {
                // Scene setup
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000a15);

                // Camera
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 0, 60);
                this.camera.lookAt(0, 0, 0);

                // Renderer
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: this.canvas, 
                    antialias: true,
                    alpha: false,
                    powerPreference: "high-performance"
                });
                
                this.renderer.setSize(window.innerWidth, window.innerHeight, false);
                this.renderer.setClearColor(0x000a15, 1.0);
                document.body.appendChild(this.canvas);

                // Galaxy 风格发光主球
                const fireballGeometry = new THREE.SphereGeometry(2.0, 32, 32);
                const fireballMaterial = new THREE.MeshBasicMaterial({
                    color: this.colorInside,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending,
                });

                this.fireball = new THREE.Mesh(fireballGeometry, fireballMaterial);
                this.scene.add(this.fireball);
                
                // 发光光环
                const haloGeometry = new THREE.SphereGeometry(3.5, 32, 32);
                const haloMaterial = new THREE.MeshBasicMaterial({
                    color: new THREE.Color('#ff8844'),
                    transparent: true,
                    opacity: 0.3,
                    blending: THREE.AdditiveBlending,
                    side: THREE.BackSide,
                });
                
                this.halo = new THREE.Mesh(haloGeometry, haloMaterial);
                this.scene.add(this.halo);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
                this.scene.add(ambientLight);
                
                this.pointLight = new THREE.PointLight(0xffa575, 2.0, 100);
                this.scene.add(this.pointLight);

                // 简化的粒子系统
                this.particleGeometry = new THREE.SphereGeometry(0.5, 8, 8);
                this.particleMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 1.0,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                });
                
                this.instancedMesh = new THREE.InstancedMesh(
                    this.particleGeometry, 
                    this.particleMaterial, 
                    this.maxParticles
                );
                
                this.scene.add(this.instancedMesh);
                
                // 初始化实例矩阵
                const matrix = new THREE.Matrix4();
                const position = new THREE.Vector3();
                const scale = new THREE.Vector3(0, 0, 0);
                
                for (let i = 0; i < this.maxParticles; i++) {
                    matrix.compose(position, new THREE.Quaternion(), scale);
                    this.instancedMesh.setMatrixAt(i, matrix);
                }
                this.instancedMesh.instanceMatrix.needsUpdate = true;

                console.log('TestLorenzAttractor initialized');
            }

            start() {
                this.animate();
            }

            animate() {
                this.animationFrameId = requestAnimationFrame(this.animate.bind(this));

                this.time += 0.016;

                // Lorenz equations
                const dx = this.sigma * (this.y - this.x) * this.dt;
                const dy = (this.x * (this.rho - this.z) - this.y) * this.dt;
                const dz = (this.x * this.y - this.beta * this.z) * this.dt;
                
                this.x += dx;
                this.y += dy;
                this.z += dz;

                // Update positions
                const scale = 0.8;
                this.fireball.position.set(this.x * scale, this.y * scale, this.z * scale);
                this.halo.position.copy(this.fireball.position);
                this.halo.scale.setScalar(1.0 + Math.sin(this.time * 2) * 0.1);
                this.pointLight.position.copy(this.fireball.position);

                // Add trail positions
                this.trailPositions.push({
                    x: this.x * scale,
                    y: this.y * scale,
                    z: this.z * scale,
                    life: 1.0
                });

                if (this.trailPositions.length > this.maxParticles) {
                    this.trailPositions.shift();
                }

                // Update particles
                const matrix = new THREE.Matrix4();
                const position = new THREE.Vector3();
                const quaternion = new THREE.Quaternion();
                const scale_vec = new THREE.Vector3();

                this.trailPositions.forEach((pos, index) => {
                    const fadeRate = (index / this.trailPositions.length);
                    const distance = Math.sqrt(pos.x * pos.x + pos.y * pos.y + pos.z * pos.z);
                    const maxDistance = 40;
                    const radiusRatio = Math.min(distance / maxDistance, 1.0);
                    const particleScale = (1.0 - radiusRatio * 0.5) * fadeRate * 1.2 + 0.3;
                    
                    position.set(
                        pos.x + (Math.random() - 0.5) * 0.08,
                        pos.y + (Math.random() - 0.5) * 0.08,
                        pos.z + (Math.random() - 0.5) * 0.08
                    );
                    scale_vec.set(particleScale, particleScale, particleScale);
                    
                    matrix.compose(position, quaternion, scale_vec);
                    this.instancedMesh.setMatrixAt(index, matrix);
                });

                // Hide unused instances
                for (let i = this.trailPositions.length; i < this.maxParticles; i++) {
                    scale_vec.set(0, 0, 0);
                    matrix.compose(position, quaternion, scale_vec);
                    this.instancedMesh.setMatrixAt(i, matrix);
                }

                this.instancedMesh.instanceMatrix.needsUpdate = true;

                // Scene rotation
                this.scene.rotation.y += 0.005;
                this.scene.rotation.x += 0.002;

                this.renderer.render(this.scene, this.camera);
                
                // Update status
                if (Math.floor(this.time * 10) % 10 === 0) {
                    document.getElementById('status').textContent = `Running (${this.trailPositions.length} particles)`;
                }
            }
        }

        try {
            new TestLorenzAttractor();
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('status').textContent = 'Error: ' + error.message;
            document.body.style.background = '#440000';
        }
    </script>
</body>
</html>
